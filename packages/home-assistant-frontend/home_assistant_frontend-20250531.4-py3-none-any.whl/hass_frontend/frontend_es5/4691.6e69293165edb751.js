"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["4691"],{27127:function(e,s,n){n.r(s),n.d(s,{ExternalAuth:()=>o,createExternalAuth:()=>d});n(40777),n(21700),n(1455);var t=n(79834);class a{async attach(){window.externalBus=e=>this.receiveMessage(e),window.addEventListener("connection-status",(e=>this.fireMessage({type:"connection-status",payload:{event:e.detail}}))),this.config=await this.sendMessage({type:"config/get"})}addCommandHandler(e){this._commandHandler=e}sendMessage(e){const s=++this.msgId;return e.id=s,this._sendExternal(e),new Promise(((e,n)=>{this.commands[s]={resolve:e,reject:n}}))}fireMessage(e){e.id||(e.id=++this.msgId),this._sendExternal(e)}receiveMessage(e){if("command"===e.type){if(!this._commandHandler||!this._commandHandler(e)){let s,n;this._commandHandler?(s="not_ready",n="Command handler not ready"):(s="unknown_command",n=`Unknown command ${e.command}`),console.warn(n,e),this.fireMessage({id:e.id,type:"result",success:!1,error:{code:s,message:n}})}return}const s=this.commands[e.id];s?"result"===e.type&&(e.success?s.resolve(e.result):s.reject(e.error)):console.warn("Received unknown msg ID",e.id)}_sendExternal(e){window.externalApp?window.externalApp.externalBus(JSON.stringify(e)):window.webkit.messageHandlers.externalBus.postMessage(e)}constructor(){this.commands={},this.msgId=0}}const r="externalAuthSetToken",i="externalAuthRevokeToken";if(!window.externalApp&&!window.webkit)throw new Error("External auth requires either externalApp or webkit defined on Window object.");class o extends t.gx{async refreshAccessToken(e){if(this._tokenCallbackPromise&&!e)try{return void(await this._tokenCallbackPromise)}catch(t){this._tokenCallbackPromise=void 0}const s={callback:r};e&&(s.force=!0),this._tokenCallbackPromise=new Promise(((e,s)=>{window[r]=(n,t)=>n?e(t):s(t)})),await Promise.resolve(),window.externalApp?window.externalApp.getExternalAuth(JSON.stringify(s)):window.webkit.messageHandlers.getExternalAuth.postMessage(s);const n=await this._tokenCallbackPromise;this.data.access_token=n.access_token,this.data.expires=1e3*n.expires_in+Date.now(),this._tokenCallbackPromise=void 0}async revoke(){const e={callback:i},s=new Promise(((e,s)=>{window[i]=(n,t)=>n?e(t):s(t)}));await Promise.resolve(),window.externalApp?window.externalApp.revokeExternalAuth(JSON.stringify(e)):window.webkit.messageHandlers.revokeExternalAuth.postMessage(e),await s}constructor(e){super({hassUrl:e,clientId:"",refresh_token:"",access_token:"",expires_in:0,expires:0})}}const d=async e=>{var s;const n=new o(e);return(null!==(s=window.externalApp)&&void 0!==s&&s.externalBus||window.webkit&&window.webkit.messageHandlers.externalBus)&&(n.external=new a,await n.external.attach()),n}}}]);
//# sourceMappingURL=4691.6e69293165edb751.js.map