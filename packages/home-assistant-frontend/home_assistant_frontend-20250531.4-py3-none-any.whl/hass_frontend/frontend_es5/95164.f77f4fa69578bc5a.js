"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["95164"],{9924:function(t,e,s){s.d(e,{t:()=>o});s(40777),s(2394),s(81738),s(22960),s(21700),s(87799),s(64510);class a{addFromStorage(t){if(!this._storage[t]){const e=this.storage.getItem(t);e&&(this._storage[t]=JSON.parse(e))}}subscribeChanges(t,e){return this._listeners[t]?this._listeners[t].push(e):this._listeners[t]=[e],()=>{this.unsubscribeChanges(t,e)}}unsubscribeChanges(t,e){if(!(t in this._listeners))return;const s=this._listeners[t].indexOf(e);-1!==s&&this._listeners[t].splice(s,1)}hasKey(t){return t in this._storage}getValue(t){return this._storage[t]}setValue(t,e){const s=this._storage[t];this._storage[t]=e;try{void 0===e?this.storage.removeItem(t):this.storage.setItem(t,JSON.stringify(e))}catch(a){}finally{this._listeners[t]&&this._listeners[t].forEach((t=>t(s,e)))}}constructor(t=window.localStorage){this._storage={},this._listeners={},this.storage=t,this.storage===window.localStorage&&window.addEventListener("storage",(t=>{t.key&&this.hasKey(t.key)&&(this._storage[t.key]=t.newValue?JSON.parse(t.newValue):t.newValue,this._listeners[t.key]&&this._listeners[t.key].forEach((e=>e(t.oldValue?JSON.parse(t.oldValue):t.oldValue,this._storage[t.key]))))}))}}const i={};function o(t){return(e,s)=>{if("object"==typeof s)throw new Error("This decorator does not support this compilation type.");const o=t.storage||"localStorage";let n;o&&o in i?n=i[o]:(n=new a(window[o]),i[o]=n);const r=t.key||String(s);n.addFromStorage(r);const c=!1!==t.subscribe?t=>n.subscribeChanges(r,((e,a)=>{t.requestUpdate(s,e)})):void 0,d=()=>n.hasKey(r)?t.deserializer?t.deserializer(n.getValue(r)):n.getValue(r):void 0,h=(e,a)=>{let i;t.state&&(i=d()),n.setValue(r,t.serializer?t.serializer(a):a),t.state&&e.requestUpdate(s,i)},l=e.performUpdate;if(e.performUpdate=function(){this.__initialized=!0,l.call(this)},t.subscribe){const t=e.connectedCallback,s=e.disconnectedCallback;e.connectedCallback=function(){t.call(this);const e=this;e.__unbsubLocalStorage||(e.__unbsubLocalStorage=null==c?void 0:c(this))},e.disconnectedCallback=function(){var t;s.call(this);const e=this;null===(t=e.__unbsubLocalStorage)||void 0===t||t.call(e),e.__unbsubLocalStorage=void 0}}const _=Object.getOwnPropertyDescriptor(e,s);let u;if(void 0===_)u={get(){return d()},set(t){(this.__initialized||void 0===d())&&(h(this,t),this.requestUpdate(s,void 0))},configurable:!0,enumerable:!0};else{const t=_.set;u=Object.assign(Object.assign({},_),{},{set(e){(this.__initialized||void 0===d())&&(h(this,e),this.requestUpdate(s,void 0)),null==t||t.call(this,e)}})}Object.defineProperty(e,s,u)}}},99153:function(t,e,s){s.a(t,(async function(t,a){try{s.r(e),s.d(e,{HuiEnergyDevicesDetailGraphCard:()=>E});s(26847),s(2394),s(44438),s(18574),s(81738),s(94814),s(29981),s(22960),s(6989),s(93190),s(87799),s(64455),s(6202),s(27530);var i=s(73742),o=s(66386),n=s(26062),r=s(59048),c=s(7616),d=s(31733),h=s(28105),l=s(55815),_=s(94412),u=(s(31138),s(37008)),p=s(6640),m=s(7214),g=s(6291),f=s(93647),v=s(94969),b=s(9924),y=s(28598),S=t([u,p,y,v]);[u,p,y,v]=S.then?(await S)():S;let k,C,w,D=t=>t;const $="kWh";class E extends((0,g.f)(r.oi)){hassSubscribe(){var t;return[(0,p.UB)(this.hass,{key:null===(t=this._config)||void 0===t?void 0:t.collection_key}).subscribe((t=>{this._data=t}))]}getCardSize(){return 3}setConfig(t){this._config=t}shouldUpdate(t){return(0,f.SN)(this,t)||t.size>1||!t.has("hass")}willUpdate(t){(t.has("_config")||t.has("_data"))&&this._processStatistics()}render(){return this.hass&&this._config?(0,r.dy)(k||(k=D` <ha-card> ${0} <div class="content ${0}"> <ha-chart-base .hass="${0}" .data="${0}" .options="${0}" @dataset-hidden="${0}" @dataset-unhidden="${0}"></ha-chart-base> </div> </ha-card> `),this._config.title?(0,r.dy)(C||(C=D`<h1 class="card-header">${0}</h1>`),this._config.title):"",(0,d.$)({"has-header":!!this._config.title}),this.hass,this._chartData,this._createOptions(this._start,this._end,this.hass.locale,this.hass.config,$,this._compareStart,this._compareEnd),this._datasetHidden,this._datasetUnhidden):r.Ld}_datasetHidden(t){this._hiddenStats=[...this._hiddenStats,t.detail.name]}_datasetUnhidden(t){this._hiddenStats=this._hiddenStats.filter((e=>e!==t.detail.name))}_processStatistics(){if(!this._data)return;const t=this._data;this._start=t.start,this._end=t.end||(0,o.p)(),this._compareStart=t.startCompare,this._compareEnd=t.endCompare;const e=t.stats,s=t.statsCompare,a=getComputedStyle(this),i=t.prefs.device_consumption,n={};i.forEach((t=>{t.included_in_stat&&(n[t.included_in_stat]=n[t.included_in_stat]||[],n[t.included_in_stat].push(t.stat_consumption))}));const r={};t.prefs.device_consumption.forEach((t=>{const s=t.stat_consumption in e&&(0,m.Kj)(e[t.stat_consumption])||0;r[t.stat_consumption]=s}));const c={};t.prefs.device_consumption.forEach((t=>{c[t.stat_consumption]=(n[t.stat_consumption]||[]).reduce(((t,e)=>t-r[e]),r[t.stat_consumption])}));const d=t.prefs.device_consumption.map((t=>t.stat_consumption));d.sort(((t,e)=>c[e]-c[t]));const h=[],{summedData:l,compareSummedData:_}=(0,p.getSummedData)(t),u="from_grid"in l||"solar"in l||"from_battery"in l,{consumption:g,compareConsumption:f}=u?(0,p.computeConsumptionData)(l,_):{consumption:void 0,compareConsumption:void 0};if(s){const e=this._processDataSet(a,s,t.statsMetadata,t.prefs.device_consumption,d,n,!0);if(h.push(...e),u){const t=this._processUntracked(a,e,f,!0);h.push(t)}}h.push({id:"compare-placeholder",type:"bar",stack:t.statsCompare?"devicesCompare":"devices",data:[]});const b=this._processDataSet(a,e,t.statsMetadata,t.prefs.device_consumption,d,n);if(h.push(...b),this._legendData=b.map((t=>{var e;return{name:t.name,itemStyle:{color:t.color,borderColor:null===(e=t.itemStyle)||void 0===e?void 0:e.borderColor}}})),u){var y;const t=this._processUntracked(a,b,g,!1);h.push(t),this._legendData.push({name:t.name,itemStyle:{color:t.color,borderColor:null===(y=t.itemStyle)||void 0===y?void 0:y.borderColor}})}(0,v.Zx)(h),this._chartData=h}_processUntracked(t,e,s,a){const i={};e.forEach((t=>{t.data.forEach((t=>{i[t[a?2:0]]=(i[t[a?2:0]]||0)+t[1]}))}));const o=(0,v.kT)(this._start,this._compareStart),n=[];Object.keys(s.used_total).sort(((t,e)=>Number(t)-Number(e))).forEach((t=>{const e=Number(t),r=[e,s.used_total[t]-(i[t]||0)];a&&(r[2]=r[0],r[0]=o(new Date(e)).getTime()),n.push(r)}));const r=Date.now();return{type:"bar",cursor:"default",id:a?`compare-untracked-${r}`:`untracked-${r}`,name:this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked_consumption"),itemStyle:{borderColor:(0,_.H)(t,this.hass.themes.darkMode,!1,a,"--state-unavailable-color")},barMaxWidth:50,color:(0,_.H)(t,this.hass.themes.darkMode,!0,a,"--state-unavailable-color"),data:n,stack:a?"devicesCompare":"devices"}}_processDataSet(t,e,s,a,i,o,n=!1){const r=[],c=(0,v.kT)(this._start,this._compareStart);return a.forEach(((a,d)=>{var h;const _=i.indexOf(a.stat_consumption);if(null!==(h=this._config)&&void 0!==h&&h.max_devices&&_>=this._config.max_devices)return void console.warn(`Max devices exceeded for ${a.name} (${_} >= ${this._config.max_devices})`);const u=(0,l.hZ)(d,t);let p=null;const g=[];if(a.stat_consumption in e){const t=e[a.stat_consumption];for(const s of t){if(null===s.change||void 0===s.change||0===s.change)continue;if(p===s.start)continue;let t=0;(o[a.stat_consumption]||[]).forEach((a=>{var i;const o=e[a];t+=(null==o||null===(i=o.find((t=>t.start===s.start)))||void 0===i?void 0:i.change)||0}));const i=[s.start,s.change-t];n&&(i[2]=i[0],i[0]=c(new Date(s.start)).getTime()),g.push(i),p=s.start}}const f=(a.name||(0,m.Kd)(this.hass,a.stat_consumption,s[a.stat_consumption]))+(a.stat_consumption in o?` (${this.hass.localize("ui.panel.lovelace.cards.energy.energy_devices_detail_graph.untracked")})`:"");r.push({type:"bar",cursor:"default",id:n?`compare-${a.stat_consumption}-${_}`:`${a.stat_consumption}-${_}`,name:f,itemStyle:{borderColor:n?u+"7F":u},barMaxWidth:50,color:n?u+"32":u+"7F",data:g,stack:n?"devicesCompare":"devices"})})),i.map((t=>r.find((e=>this._getStatIdFromId(e.id)===t)))).filter(Boolean)}_getStatIdFromId(t){return t.replace(/^compare-/,"").replace(/-\d+$/,"")}constructor(...t){super(...t),this._chartData=[],this._start=(0,n.I)(),this._end=(0,o.p)(),this._hiddenStats=[],this.hassSubscribeRequiredHostProps=["_config"],this._formatTotal=t=>this.hass.localize("ui.panel.lovelace.cards.energy.energy_usage_graph.total_consumed",{num:(0,y.uf)(t,this.hass.locale),unit:$}),this._createOptions=(0,h.Z)(((t,e,s,a,i,o,n)=>{const r=(0,v.J)(t,e,s,a,i,o,n,this._formatTotal);return Object.assign(Object.assign({},r),{},{legend:{show:!0,type:"custom",data:this._legendData,selected:this._hiddenStats.reduce(((t,e)=>(t[e]=!1,t)),{})},grid:{top:15,bottom:0,left:1,right:1,containLabel:!0}})}))}}E.styles=(0,r.iv)(w||(w=D`.card-header{padding-bottom:0}.content{padding:16px}.has-header{padding-top:0}`)),(0,i.__decorate)([(0,c.Cb)({attribute:!1})],E.prototype,"hass",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_config",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_chartData",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_data",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_legendData",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_start",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_end",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_compareStart",void 0),(0,i.__decorate)([(0,c.SB)()],E.prototype,"_compareEnd",void 0),(0,i.__decorate)([(0,c.SB)(),(0,b.t)({key:"energy-devices-hidden-stats",state:!0,subscribe:!1})],E.prototype,"_hiddenStats",void 0),E=(0,i.__decorate)([(0,c.Mo)("hui-energy-devices-detail-graph-card")],E),a()}catch(k){a(k)}}))}}]);
//# sourceMappingURL=95164.f77f4fa69578bc5a.js.map