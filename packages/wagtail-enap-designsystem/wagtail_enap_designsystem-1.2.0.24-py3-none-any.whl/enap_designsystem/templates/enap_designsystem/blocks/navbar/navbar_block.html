{% load wagtailcore_tags wagtailimages_tags %}
{% load static %}

<script src="https://kit.fontawesome.com/2e8803d931.js" crossorigin="anonymous"></script>

<div style="background-color: #f8fafc;">
	<nav class="navbar">
		<div class"mobile-ss" style="max-width: 1142px; width: 1142px; margin: auto; display: flex; justify-content: space-between;">
					<!-- Menu Hamburguer + Logo -->
		<div class"wrapper-nav-home" style="display: flex; align-items: center; gap: 20px;">
			<div class="menu-container">
				<!-- Ícone do Menu -->
				<button class="menu-icon" onclick="toggleMenu()">
					<span style="color: #007D7A;" class="material-icons">menu</span>
				</button>
		
				<!-- Dropdown do Menu -->
				<div id="menu-dropdown" class="menu-dropdown hidden">
					{% if navbar.links %}
						{% for link_block in navbar.links %}
							{% if link_block.block_type == 'navbar_link' %}
								<!-- Link normal -->
								<a href="{{ link_block.value.url }}" class="nav-link-nav" target="_blank">
									{{ link_block.value.label }}
								</a>
							{% elif link_block.block_type == 'chooserpage' %}
								<!-- ChooserPage Menu -->
								<div class="chooser-menu-item">
									<div class="chooser-title" onclick="toggleChooserSubmenu(this)">
										<span>{{ link_block.value.title }}</span>
										<i class="material-icons">keyboard_arrow_right</i>
									</div>
									
									<!-- Submenu das páginas -->
									<div class="chooser-submenu">
										<div class="submenu-content-horizontal">
											<div id="childList-{{ forloop.counter0 }}" class="child-pages-container-horizontal">
												<!-- As páginas filhas aparecerão automaticamente -->
											</div>
										</div>
										
										<!-- Dados escondidos para o JavaScript -->
										<div style="display: none;" class="hidden-parent-data" data-chooser-id="{{ forloop.counter0 }}">
											{% for parent_item in link_block.value.parent_pages %}
												<div data-page-id="{{ parent_item.page.id }}" data-max-children="{{ link_block.value.max_child_pages|default:10 }}" data-show-descriptions="{{ link_block.value.show_child_descriptions }}">
													{% for child in parent_item.page.get_children.live %}
														<span data-title="{{ child.title|escapejs }}" data-url="{% pageurl child %}" data-description="{% if link_block.value.show_child_descriptions and child.search_description %}{{ child.search_description|escapejs }}{% endif %}"></span>
													{% endfor %}
												</div>
											{% endfor %}
										</div>
									</div>
								</div>
							{% endif %}
						{% endfor %}
					{% else %}
						<span class="text-red-500">⚠️ Nenhum link cadastrado.</span>
					{% endif %}
				</div>
			</div>
		
			<!-- Logo -->
			<div class="logo-enap">
                <a href="/" class="navbar-logo-link">
                    {% for block in navbar.logo %}
                        {% if ".svg" in block.value.file.url|lower %}
                            <img src="{{ block.value.file.url }}" >
                        {% else %}
                            {% image block.value fill-118x18 format-webp as navbar_logo %}
                            <img src="{{ navbar_logo.url }}" alt="ENAP" class="logo-navbar">
                        {% endif %}
                    {% endfor %}
                </a>
            </div>
	
		<!-- Barra de Pesquisa -->
		<form action="/busca/" method="get" class="search-container">
            <input type="text" id="search-input" name="q" placeholder="O que você procura ou quer aprender?" value="{{ query_navbar }}">
            <button type="submit">
                <span class="material-icons">search</span>
            </button>
            <button type="button" id="mic-button">
                <span class="material-icons">mic</span>
            </button>
        </form>
	
		<!-- Opções à Direita -->
		<div class="options">
			<!-- Seletor de Idioma -->
			<button>
				PT <span class="material-icons">expand_more</span>
			</button>
	
			<!-- Botão de Contraste -->
			<button>
				<span class="material-icons">contrast</span>
			</button>
	
			<!-- Botão de Login -->
			{% if aluno %}
				<a href="/area-do-aluno/" class="login-btn">
					<i class="fa-solid fa-circle-user"></i>
					<span>Olá, {{ primeiro_nome }}</span>
				</a>
				<a href="/logout" class="logout-btn">Sair</a>
			{% else %}
				<a href="/login-sso" class="login-btn">
					<i class="fa-solid fa-circle-user"></i>
					<span>Entrar</span>
				</a>
			{% endif %}
		</div>
		</div>
	</nav>
</div>

<style>
/* Estilos para o dropdown principal */
.menu-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    background: #025257;
    border-radius: 0px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 300px;
    max-width: 350px;
    z-index: 1000;
    transition: all 0.3s ease;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    gap: 0px;
}

.menu-dropdown.dropdown-active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    display: flex;
	flex-direction: column;
}

/* Estilos base para nav-link */
.nav-link {
    display: block;
    padding: 12px 46px;
    text-decoration: none;
    color: white;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 14px;
}

.nav-link:hover {
    background: #006969;
    color: white;
    text-decoration: none;
}

/* Estilos para o ChooserPage no navbar */
.chooser-menu-item {
    position: relative;
    font-size: 14px;
    font-weight: 400;
}

.chooser-menu-item:last-child {
    border-bottom: none;
}

.chooser-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    cursor: pointer;
    color: white;
    font-weight: 500;
    transition: all 0.2s ease;
    background: #025257;
    position: relative;
}

.chooser-title:hover {
    background: #006969;
    color: white;
}

.chooser-title.active {
    background: #024248;
    color: white;
}

.chooser-title .material-icons {
    font-size: 18px;
    transition: transform 0.2s ease;
}

.chooser-title.active .material-icons {
    transform: rotate(0deg); /* Mantém a seta para direita quando ativo */
}

/* Submenu lateral para páginas filhas */
.chooser-submenu {
    position: absolute;
    left: 100%;
    top: 0;
    background: #006969;
    border-radius: 0;
    box-shadow: 4px 0 12px rgba(0,0,0,0.1);
    min-width: 300px;
    max-width: 400px;
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transform: translateX(-10px);
    transition: all 0.3s ease;
    border-left: 1px solid rgba(255,255,255,0.1);
}

.chooser-submenu.active {
    opacity: 1;
    visibility: visible;
    transform: translateX(0);
}

/* Container para as páginas filhas */
.submenu-content-horizontal {
    padding: 0;
}

.child-pages-container-horizontal {
    max-height: 400px;
    overflow-y: auto;
}

.child-pages-container-horizontal .child-pages-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.child-pages-container-horizontal .child-page-item {
    margin-bottom: 0;
}

.child-pages-container-horizontal .child-page-item:last-child {
    border-bottom: none;
}

.child-pages-container-horizontal .child-page-link {
    display: block;
    padding: 12px 20px;
    text-decoration: none;
    color: white;
    transition: all 0.2s ease;
    font-size: 14px;
    border-radius: 0;
    border-left: 3px solid transparent;
    font-weight: 400;
}

.child-pages-container-horizontal .child-page-link:hover {
    color: white;
    background: #024248;
    text-decoration: none;
}

.child-pages-container-horizontal ul li {
    margin: 0;
    padding: 0;
    color: white;
}

.no-selection {
    color: rgba(255,255,255,0.6);
    font-style: italic;
    text-align: center;
    padding: 30px 20px;
    margin: 0;
    font-size: 13px;
}

/* Scrollbar personalizada */
.child-pages-container-horizontal::-webkit-scrollbar {
    width: 5px;
}

.child-pages-container-horizontal::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
}

.child-pages-container-horizontal::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
}

.child-pages-container-horizontal::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.5);
}

/* Responsivo para mobile */
@media (max-width: 768px) {
    .menu-dropdown {
        min-width: 280px;
        max-width: 90vw;
    }
    
    .chooser-submenu {
        position: static;
        transform: none;
        border-radius: 0;
        box-shadow: none;
        border-left: none;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .chooser-submenu.active {
        transform: none;
    }
}

/* Estilos restantes mantidos iguais */
.submenu-content {
    display: flex;
    min-height: 300px;
}

.submenu-left, .submenu-right {
    flex: 1;
    padding: 16px;
}

.submenu-left {
    border-right: 1px solid #e5e7eb;
    background: #f9fafb;
}

.submenu-left h4, .submenu-right h4 {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.parent-pages-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.parent-page-item {
    margin-bottom: 2px;
}

.parent-page-link {
    display: flex;
    align-items: center;
    padding: 12px 14px;
    text-decoration: none;
    color: #374151;
    border-radius: 6px;
    transition: all 0.2s ease;
    gap: 10px;
    font-size: 14px;
    border-left: 3px solid transparent;
}

.parent-page-link:hover, .parent-page-link.active {
    background: #e0f2f1;
    color: #007D7A;
    text-decoration: none;
    border-left-color: #007D7A;
    transform: translateX(2px);
}

.parent-page-link .material-icons:first-child {
    font-size: 18px;
    min-width: 18px;
}

.parent-page-link .arrow {
    margin-left: auto;
    font-size: 16px;
    opacity: 0.6;
}

.child-pages-container {
    max-height: 250px;
    overflow-y: auto;
}

.child-pages-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.child-page-item {
    margin-bottom: 6px;
}

.child-page-link {
    display: block;
    padding: 10px 14px;
    text-decoration: none;
    color: #374151;
    border-radius: 6px;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
    font-size: 14px;
}

.child-page-link:hover {
    border-left-color: 3px solid #006969;
    text-decoration: none;
    transform: translateX(2px);
}

.child-page-title {
    font-weight: 500;
    margin-bottom: 3px;
}

.child-page-description {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.4;
}

.no-selection {
    color: #9ca3af;
    font-style: italic;
    text-align: center;
    padding: 30px 20px;
    margin: 0;
    font-size: 13px;
}

/* Scrollbar personalizada */
.child-pages-container::-webkit-scrollbar {
    width: 5px;
}

.child-pages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.child-pages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.child-pages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Responsivo para mobile */
@media (max-width: 768px) {
    .menu-dropdown {
        min-width: 280px;
        max-width: 90vw;
    }
    
    .submenu-content {
        flex-direction: column;
        min-height: auto;
    }
    
    .submenu-left {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .chooser-submenu {
        margin: 8px -8px;
    }
    
}

@media (max-width: 600px) {
	.search-container .material-icons {
		font-size: 16px;
	}
}

.search-container .material-icons {
	font-size: 20px;
}

#mic-button {
    border-radius: 50%;
    padding: 8px;
    cursor: pointer;
    transition: background-color 0.2s, box-shadow 0.2s;
}

/* Estado ouvindo */
#mic-button.listening {
    background-color: #0A7263;
    color: white;
    border-color: #0A7263;
    box-shadow: 0 0 8px rgba(10, 114, 99, 0.6);
}

#mic-button span {
    font-size: 20px;
    pointer-events: none;
}
</style>

<script>
	// Sua função original do menu - mantida como está
	function toggleMenu() {
		const menu = document.getElementById("menu-dropdown");
		menu.classList.toggle("dropdown-active");
	}

	// Função para mostrar submenu e carregar todas as páginas filhas automaticamente
	function toggleChooserSubmenu(element) {
		const submenu = element.nextElementSibling;
		const isActive = element.classList.contains('active');
		
		// Fecha todos os outros submenus
		document.querySelectorAll('.chooser-title.active').forEach(title => {
			title.classList.remove('active');
			title.nextElementSibling.classList.remove('active');
		});
		
		// Toggle do submenu atual
		if (!isActive) {
			element.classList.add('active');
			submenu.classList.add('active');
			
			// Automaticamente carrega todas as páginas filhas
			setTimeout(() => {
				loadAllChildPages(submenu);
			}, 100);
		}
	}

	// Nova função para carregar todas as páginas filhas de uma vez
	function loadAllChildPages(submenu) {
		const hiddenData = submenu.querySelector('.hidden-parent-data');
		const chooserId = hiddenData.getAttribute('data-chooser-id');
		const childList = submenu.querySelector(`#childList-${chooserId}`);
		
		let allChildren = [];
		
		// Coleta todas as páginas filhas de todas as páginas mãe
		hiddenData.querySelectorAll('[data-page-id]').forEach(parentData => {
			const childElements = parentData.querySelectorAll('span[data-title]');
			childElements.forEach(childEl => {
				allChildren.push({
					title: childEl.getAttribute('data-title'),
					url: childEl.getAttribute('data-url'),
					description: childEl.getAttribute('data-description')
				});
			});
		});
		
		// Mostra todas as páginas filhas em layout horizontal
		if (allChildren.length > 0) {
			let html = '<ul class="child-pages-list">';
			allChildren.forEach(function(child) {
				html += `
					<li class="child-page-item">
						<a href="${child.url}" class="child-page-link">
							<div class="child-page-title">${child.title}</div>
							${child.description ? `<div class="child-page-description" style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px;">${child.description}</div>` : ''}
						</a>
					</li>
				`;
			});
			html += '</ul>';
			childList.innerHTML = html;
		} else {
			childList.innerHTML = '<p class="no-selection">Nenhuma página encontrada</p>';
		}
	}

	// Dados das páginas filhas para o navbar - agora simplificado
	const navbarChildPagesData = {};

	// Remove a função showChildPagesInNavbar pois não precisamos mais dela

	// Fecha menu ao clicar fora
	document.addEventListener('click', function(e) {
		if (!e.target.closest('.menu-container')) {
			document.getElementById('menu-dropdown').classList.remove('dropdown-active');
			// Fecha também todos os submenus
			document.querySelectorAll('.chooser-title.active').forEach(title => {
				title.classList.remove('active');
				title.nextElementSibling.classList.remove('active');
			});
		}
	});

	// Seus scripts existentes mantidos como estão
	window.addEventListener('scroll', function() {
		const navbar = document.querySelector('.navbar');
		
		// Adiciona classe fixa quando rolar mais que a altura inicial da navbar
		if (window.scrollY > navbar.offsetHeight) {
			navbar.classList.add('navbar-fixed');
		} else {
			navbar.classList.remove('navbar-fixed');
		}
	});

	function clearInput() {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchInput').focus();
        toggleClearButton();
    }

    function toggleClearButton() {
        const input = document.getElementById('searchInput');
        const clearButton = document.getElementById('clearButton');
        clearButton.style.display = input.value ? 'block' : 'none';
    }

    // Função para verificar se é dispositivo móvel
    function isMobile() {
        return window.innerWidth <= 768; // Defina o breakpoint apropriado para seu site
    }

    // Quando o documento carrega, torna o search container visível apenas no desktop
    document.addEventListener('DOMContentLoaded', function() {
        const searchContainer = document.querySelector('.search-container');
        
        if (!isMobile()) {
            // Versão desktop - sempre visível
            searchContainer.classList.add('visible');
            searchContainer.classList.add('show');
        }
    });

    // Durante o scroll, comportamento responsivo
    window.addEventListener('scroll', function() {
        const searchContainer = document.querySelector('.search-container');
        const scrollPosition = window.scrollY;
        
        if (isMobile()) {
            // Versão mobile - só visível após scroll
            if (scrollPosition > 200) {
                searchContainer.classList.add('show');
            } else {
                searchContainer.classList.remove('show');
            }
        } else {
            // Versão desktop - sempre visível
            searchContainer.classList.add('visible');
            searchContainer.classList.add('show');
        }
    });

    // Recalcular quando a janela for redimensionada
    window.addEventListener('resize', function() {
        const searchContainer = document.querySelector('.search-container');
        
        if (!isMobile()) {
            // Versão desktop - sempre visível
            searchContainer.classList.add('visible');
            searchContainer.classList.add('show');
        } else {
            // Versão mobile - verificar posição de scroll
            const scrollPosition = window.scrollY;
            if (scrollPosition <= 200) {
                searchContainer.classList.remove('show');
            }
        }
    });

	const micButton = document.getElementById('mic-button');
	const searchInput = document.getElementById('search-input');

	// Verifica suporte do navegador
	const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

	if (SpeechRecognition) {
		const recognition = new SpeechRecognition();
		recognition.lang = 'pt-BR';
		recognition.continuous = false;
		recognition.interimResults = false;

		// Clicou no microfone → começa a ouvir
		micButton.addEventListener('click', () => {
			recognition.start();
			micButton.classList.add('listening');
		});

		// Quando captura a voz
		recognition.addEventListener('result', (event) => {
			const transcript = Array.from(event.results)
				.map(result => result[0].transcript)
				.join('');

			searchInput.value = transcript;
		});

		// Quando finaliza (parou de ouvir)
		recognition.addEventListener('end', () => {
			micButton.classList.remove('listening');
		});

		// Se der erro, remove o estado listening
		recognition.addEventListener('error', () => {
			micButton.classList.remove('listening');
		});
	} else {
		// Se não suportar, esconde o botão
		micButton.style.display = 'none';
	}
</script>

