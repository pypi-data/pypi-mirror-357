image: atlassian/default-image:3

definitions:
  steps:
    - step: &Test
        name: "Run unit tests"
        image: python:3.12
        script:
          - pip install -r requirements.txt
          - (cd src && python -m unittest)
    - step: &Lint
        name: "Run linting checks"
        image: python:3.12
        script:
          - pip install black
          - black --check src/
    - step: &Validate-Branch-For-Tag-Step
        name: Validating branch & tag combination
        script:
          - |
            echo "Fetching all the git remote references (such as tags)."
            git fetch origin "+refs/heads/*:refs/remotes/origin/*"

            if [[ "$BITBUCKET_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ ]]; then
              VALID_BRANCH="^.*remotes/origin/(release|hotfix)/.*$"
              DEPLOYMENT_ENVIRONMENT="rc"
            elif [[ "$BITBUCKET_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-alpha\.[0-9]+$ ]]; then
              VALID_BRANCH="^.*remotes/origin/(release|hotfix)/.*$"
              DEPLOYMENT_ENVIRONMENT="staging"
            elif [[ "$BITBUCKET_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              VALID_BRANCH="^.*remotes/origin/master$"
              DEPLOYMENT_ENVIRONMENT="production"
            else
              echo "Tag \"$BITBUCKET_TAG\" has an invalid format. Aborting..."
              exit -1
            fi

            echo "Verifying that tag \"$BITBUCKET_TAG\" is applied on a branch matching \"$VALID_BRANCH\"."
            FOUND=false

            TAG_BRANCHES=$(git branch -a --contains "$BITBUCKET_TAG")
            echo "Branches to which tag $BITBUCKET_TAG is applied: "
            echo $TAG_BRANCHES

            while IFS= read -r BRANCH ; do 
              NORMALIZED_BRANCH=$(echo $BRANCH | sed -E -e "s/(\* )|(  )//")

              if [ "$(echo $NORMALIZED_BRANCH | grep -cm1 -E "$VALID_BRANCH")" -eq 1 ]; then
                FOUND=true
                echo "Tag \"$BITBUCKET_TAG\" is applied to a valid branch: \"$NORMALIZED_BRANCH\"."
                break
              fi
            done <<< "$TAG_BRANCHES"

            if ! $FOUND; then
              echo "Tag \"$BITBUCKET_TAG\" was not found on a branch matching \"$VALID_BRANCH\". Aborting..."
              exit -1
            fi

pipelines:
  default:
    - parallel:
        - step: *Test
        - step: *Lint
  branches:
    "release/*":
      - parallel:
          - step: *Test
          - step: *Lint
  tags:
    "{v*.*.*}":
      - step: *Validate-Branch-For-Tag-Step
      - parallel:
          - step: *Test
          - step: *Lint
  pull-requests:
    "*":
      - parallel:
          - step: *Test
          - step: *Lint
