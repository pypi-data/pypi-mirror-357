image: python:3.11

variables:
  GIT_DEPTH: 0

stages:
  - version
  - deploy

# Update the package version number based on commit messages
update_version:
  stage: version
  image: python:3.11-slim
  # This job will only run on pushes to the main branch.
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip-version\]/'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG == null'
  before_script:
    - apt-get update
    - apt-get install -y git
    - git checkout "${CI_COMMIT_BRANCH}"
  script:
    - echo "Starting semantic release process..."
    - pip install python-semantic-release python-semantic-release[git]
    - git config --global user.name "Devs"
    - git config --global user.email "developers@ready-links.com"
    - semantic-release version

# Deploy to Gitlab registry
deploy_to_gitlab:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_TAG != null'
  before_script:
    - pip install hatch
  script:
    - hatch build
    - hatch publish -r "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi" -u __token__ -a ${CI_JOB_TOKEN}

# Deploy to PyPi registry
deploy_to_pypi:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_TAG != null'
  before_script:
    - pip install hatch
  script:
    - echo "Building package for PyPI..."
    - hatch build
    - echo "Publishing to public PyPI..."
    - hatch publish -u __token__ -a ${PYPI_API_TOKEN}  --no-prompt
