name: Dependabot auto-approve

on:
    workflow_call:
        inputs:
            PR_URL:
                description: "URL of the pull request"
                required: true
                type: string
        secrets:
            GH_PAT:
                description: "Dependabot Secret Personal Access Token"
                required: true

permissions:
    pull-requests: write
    contents: write

jobs:
    dependabot:
        runs-on: self-hosted
        if: github.event.pull_request.user.login == 'dependabot[bot]' && github.repository == 'Cognyx/ai-server'
        steps:
        -   name: Dependabot metadata
            id: metadata
            uses: dependabot/fetch-metadata@v2
            with:
                github-token: "${{ secrets.GITHUB_TOKEN }}"

        -   name: "Checkout GitHub Action"
            uses: actions/checkout@v4

        -   name: Auto-approve and enable auto-merge for patch and minor updates
            if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
            run: |
                gh pr review --approve "$PR_URL"
                # gh pr merge --auto --squash "$PR_URL"
            env:
                PR_URL: ${{ inputs.PR_URL }}
                GH_TOKEN: ${{ secrets.GH_PAT }}
