Metadata-Version: 2.4
Name: svc_user_auth_zxw
Version: 2.1.0
Summary: ç”¨æˆ·æƒé™éªŒè¯å·¥å…·åŒ…
Home-page: https://github.com/sunshineinwater/
Author: æ™¯å‹Ÿ
Author-email: 
Classifier: Programming Language :: Python :: 3.10
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Description-Content-Type: text/markdown
Requires-Dist: pycryptodome<=3.22.0,>=3.20.0
Requires-Dist: fastapi<0.113,>=0.112.0
Requires-Dist: jose<1.1.0,>=1.0.0
Requires-Dist: aiohttp<3.11.0,>=3.10.5
Requires-Dist: httpx<=0.27.0,>=0.23.3
Requires-Dist: sqlalchemy==2.0.32
Requires-Dist: greenlet==3.0.3
Requires-Dist: databases==0.9.0
Requires-Dist: python-jose==3.3.0
Requires-Dist: passlib==1.7.4
Requires-Dist: asyncpg==0.29.0
Requires-Dist: uvicorn<0.31.0,>=0.30.0
Requires-Dist: python-multipart==0.0.9
Requires-Dist: bcrypt==4.2.0
Requires-Dist: app-tools-zxw>=1.0.86
Requires-Dist: alibabacloud_dysmsapi20170525==3.0.0
Requires-Dist: redis==5.2.0
Requires-Dist: apscheduler==3.10.4
Dynamic: author
Dynamic: classifier
Dynamic: description
Dynamic: description-content-type
Dynamic: home-page
Dynamic: requires-dist
Dynamic: summary

# svc_user_auth_zxw ç”¨æˆ·è®¤è¯æƒé™ç®¡ç†åº“

## ğŸ“š ç®€ä»‹

`svc_user_auth_zxw` æ˜¯ä¸€ä¸ªåŸºäº FastAPI çš„ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç† Python åº“ï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™éªŒè¯ç­‰åŠŸèƒ½ã€‚æ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼ŒåŒ…æ‹¬è´¦å·å¯†ç ã€å¾®ä¿¡ç™»å½•ã€æ‰‹æœºå·éªŒè¯ç ç™»å½•ç­‰ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ” **å¤šç§ç™»å½•æ–¹å¼**ï¼šè´¦å·å¯†ç ã€å¾®ä¿¡ã€æ‰‹æœºéªŒè¯ç 
- ğŸ¯ **çµæ´»çš„è§’è‰²æƒé™ç®¡ç†ç³»ç»Ÿ**
- ğŸ’ **å®Œæ•´çš„ä¼šå‘˜ä½“ç³»åŠŸèƒ½**
  - ğŸ“‹ ä¼šå‘˜ç±»å‹ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ï¼‰
  - ğŸ‘¥ ç”¨æˆ·ä¼šå‘˜ç®¡ç†ï¼ˆè´­ä¹°ã€ç»­è´¹ã€çŠ¶æ€ç®¡ç†ï¼‰
  - ğŸ›¡ï¸ ä¼šå‘˜æƒé™éªŒè¯è£…é¥°å™¨
  - â° è‡ªåŠ¨è¿‡æœŸä¼šå‘˜æ¸…ç†
  - ğŸ”„ ä¼šå‘˜ä¸è§’è‰²æƒé™æ•´åˆ
- ğŸ”‘ **JWT Token è®¤è¯æœºåˆ¶**
- ğŸ“± **çŸ­ä¿¡éªŒè¯ç æ”¯æŒ**
- ğŸ—„ï¸ **Redis ç¼“å­˜æ”¯æŒ**
- ğŸ¨ **é€‚é… Vue-Element-Plus-Admin æ¡†æ¶**
- ğŸš€ **å¼‚æ­¥æ•°æ®åº“æ“ä½œï¼ˆPostgreSQLï¼‰**
- ğŸ”„ **Token åˆ·æ–°æœºåˆ¶**

## ğŸ“‹ ç›®å½•

1. [ç‰ˆæœ¬å†å²](#ç‰ˆæœ¬å†å²)
2. [å®‰è£…](#å®‰è£…)
3. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
4. [æ ¸å¿ƒAPIæ–‡æ¡£](#æ ¸å¿ƒapiæ–‡æ¡£)
5. [ä¼šå‘˜ä½“ç³»](#ä¼šå‘˜ä½“ç³»)
6. [æƒé™ç®¡ç†](#æƒé™ç®¡ç†)
7. [å‰ç«¯é›†æˆ](#å‰ç«¯é›†æˆ)
8. [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
9. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
10. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)

## ğŸ“ˆ ç‰ˆæœ¬å†å²

### æœ€æ–°ç‰ˆæœ¬
- **2.1.0** ğŸ‰ **é‡å¤§æ›´æ–°**: æ–°å¢å®Œæ•´çš„ä¼šå‘˜ä½“ç³»åŠŸèƒ½
  - æ·»åŠ ä¼šå‘˜ç±»å‹ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€åˆ é™¤ï¼‰
  - æ·»åŠ ç”¨æˆ·ä¼šå‘˜ç®¡ç†ï¼ˆè´­ä¹°ã€ç»­è´¹ã€çŠ¶æ€ç®¡ç†ï¼‰
  - æ·»åŠ ä¼šå‘˜æƒé™éªŒè¯è£…é¥°å™¨å’ŒAPI
  - æ·»åŠ å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šå‘˜
  - ä¼šå‘˜æƒé™ä¸è§’è‰²æƒé™ç³»ç»Ÿæ— ç¼æ•´åˆ
  - âš ï¸ **éå…¼å®¹æ€§æ›´æ–°**ï¼Œä¸ä¹‹å‰ç‰ˆæœ¬ä¸å…¼å®¹

### è¿‘æœŸç‰ˆæœ¬
- **2.0.4**: æ·»åŠ uniAppæ‰‹æœºå·ç™»å½•é¡µ(å…·å¤‡å®Œå¤‡çš„apiè¯·æ±‚é€»è¾‘, å¤åˆ¶åˆ°é¡¹ç›®å†…ç›´æ¥ä½¿ç”¨)
- **2.0.3**: é˜¿é‡Œäº‘smså‘é€å¢åŠ loggerè®°å½•
- **2.0.2**: é˜¿é‡Œäº‘smså‘é€é…ç½®ä½¿ç”¨configä¸­é…ç½®, ä¸ºNoneæ—¶ä½¿ç”¨é»˜è®¤é…ç½®
- **2.0.1**: ä¿®æ­£ä½¿ç”¨æ–‡æ¡£é”™è¯¯
- **2.0.0**: é¡¹ç›®ç”± user_auth_zxw æ›´åä¸º svc_user_auth_zxw

### 1.0.x ç‰ˆæœ¬ï¼ˆé€‚é…VUE-ELEMENT-PLUS-ADMINæ¡†æ¶ï¼‰
- **1.0.5**: ç”¨æˆ·æ–‡æ¡£é”™è¯¯ä¿®æ­£
- **1.0.4**: æ·»åŠ ç”¨æˆ·æ–‡æ¡£
- **1.0.3**: bug fixï¼Œæ–°ç”¨æˆ·æ³¨å†Œåto_payload()æŠ¥é”™ä¿®å¤ï¼Œä¼˜åŒ–ç”¨æˆ·è§’è‰²å…³è”æ•°æ®åŠ è½½
- **1.0.2**: ä¼˜åŒ–è´¦å·å¯†ç æ³¨å†Œç™»å½•è¿”å›å€¼ï¼Œå˜æ›´æ•°æ®è¡¨ç»“æ„ï¼šRoleé‡‡ç”¨è”åˆä¸»é”®ï¼š(app_id, name)
- **1.0.1**: æ–°å¢vue-element-plus-admin api: é€€å‡ºç™»å½•
- **1.0.0**: ç»Ÿä¸€APIè¿”å›å€¼ï¼Œç¬¦åˆvue-element-plus-adminæ¡†æ¶åŸç”Ÿæ ‡å‡†

### æ—©æœŸç‰ˆæœ¬
- **0.1.1**: æ”¯æŒå¤šçº¿ç¨‹ä»»åŠ¡ï¼Œé›†æˆä¿®æ”¹: çŸ­ä¿¡éªŒè¯ç éªŒè¯ï¼Œrediså­˜å‚¨ä¸éªŒè¯
- **0.1.0**: ä¿®æ”¹: jwtéªŒè¯å¤±è´¥, å¼¹å‡º401 HTTPException_AppToolsSZXWå¼‚å¸¸
- **0.0.9**: è¡¨ç»“æ„Useræ–°å¢å­—æ®µ:referer_id,referer,inviteesï¼Œæ‰‹æœºå·æ³¨å†Œç™»å½•æ–°å¢ç›¸åº”å­—æ®µï¼Œå¢åŠ é‚€è¯·äººä¿¡æ¯
- **0.0.8**: æ–°å¢:æ‰¹é‡åˆ é™¤ç”¨æˆ·è§’è‰²(delete_roles)

## ğŸš€ å®‰è£…

### é€šè¿‡ pip å®‰è£…

```bash
pip install svc_user_auth_zxw
```

## âš¡ å¿«é€Ÿå¼€å§‹

### 1. é¡¹ç›®é…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `configs/config_user_auth.py` æ–‡ä»¶ï¼š

```python
import os
from datetime import timedelta

# PostgreSQL æ•°æ®åº“é…ç½®
DATABASE_URL = os.environ.get('USER_CENTER_DATABASE_URL')
if not DATABASE_URL:
    DATABASE_URL = "postgresql+asyncpg://username:password@localhost:5432/database_name"
    os.environ['USER_CENTER_DATABASE_URL'] = DATABASE_URL

# Redis æ•°æ®åº“é…ç½®
REDIS_URL_AUTH = os.environ.get('REDIS_URL_AUTH')
if not REDIS_URL_AUTH:
    REDIS_URL_AUTH = "redis://:your_redis_password@localhost:6379/0"
    os.environ['REDIS_URL_AUTH'] = REDIS_URL_AUTH

# JWT é…ç½®
class JWT:
    SECRET_KEY = "your-secret-key-here"
    ALGORITHM = "HS256"
    expire_time = timedelta(seconds=3600)  # 1å°æ—¶

# åº”ç”¨é…ç½®
app_name = "your_app_name"

# å¾®ä¿¡é…ç½®ï¼ˆå¯é€‰ï¼‰
class WeChatPub:
    app_id = "your_wechat_app_id"
    app_secret = "your_wechat_app_secret"
    scope = "snsapi_login"
    state = "your_custom_state"

# é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®ï¼ˆå¯é€‰ï¼‰
class AliyunSMS:
    ali_access_key_id = "your_access_key_id"
    ali_access_key_secret = "your_access_key_secret"
```

### 2. FastAPI åº”ç”¨é›†æˆ

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from svc_user_auth_zxw import router as user_auth_router
from svc_user_auth_zxw.tools.scheduler import start_membership_scheduler, stop_membership_scheduler

# åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåŒ…å«ä¼šå‘˜ä½“ç³»å®šæ—¶ä»»åŠ¡ï¼‰
@asynccontextmanager
async def lifespan(app: FastAPI):
    # å¯åŠ¨æ—¶
    print("ğŸš€ å¯åŠ¨ç”¨æˆ·è®¤è¯æœåŠ¡...")
    await start_membership_scheduler()  # å¯åŠ¨ä¼šå‘˜æ¸…ç†å®šæ—¶ä»»åŠ¡
    print("â° ä¼šå‘˜å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨")
    yield
    # å…³é—­æ—¶
    print("â¹ï¸ åœæ­¢ä¼šå‘˜å®šæ—¶ä»»åŠ¡...")
    await stop_membership_scheduler()
    print("âœ… ç”¨æˆ·è®¤è¯æœåŠ¡å·²å…³é—­")

# åˆ›å»º FastAPI åº”ç”¨
app = FastAPI(
    title="ä½ çš„åº”ç”¨",
    description="åŸºäº svc_user_auth_zxw çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ",
    lifespan=lifespan
)

# æ·»åŠ  CORS ä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç”Ÿäº§ç¯å¢ƒè¯·è®¾ç½®å…·ä½“åŸŸå
    allow_credentials=True,
    allow_methods=["GET", "POST", "DELETE", "PUT", "OPTIONS"],
    allow_headers=["*"],
)

# æ³¨å†Œç”¨æˆ·è®¤è¯è·¯ç”±
app.include_router(user_auth_router, prefix="/user_center", tags=["ç”¨æˆ·è®¤è¯"])

# å¥åº·æ£€æŸ¥æ¥å£
@app.get("/")
async def root():
    return {"message": "ç”¨æˆ·è®¤è¯æœåŠ¡è¿è¡Œæ­£å¸¸", "version": "2.1.0"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### 3. æ•°æ®åº“åˆå§‹åŒ–

åœ¨é¡¹ç›®ä¸»å‡½æ•°å¯¼å…¥ `from svc_user_auth_zxw import router` æ¨¡å—æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œæ•°æ®åº“åˆå§‹åŒ–ã€‚

### 4. åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

```python
from fastapi import Depends
from svc_user_auth_zxw import get_current_user, require_role
from svc_user_auth_zxw.apis.api_ä¼šå‘˜æƒé™éªŒè¯ import require_membership

# è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
@app.get("/profile")
async def get_profile(current_user=Depends(get_current_user)):
    return {"user": current_user.username, "roles": current_user.roles}

# éœ€è¦ç®¡ç†å‘˜æƒé™çš„æ¥å£
@app.get("/admin-data")
async def admin_only(user=Depends(require_role("admin", "your_app"))):
    return {"message": "ç®¡ç†å‘˜ä¸“ç”¨æ•°æ®", "user": user.username}

# éœ€è¦VIPä¼šå‘˜æƒé™çš„æ¥å£
@app.get("/vip-content")
async def vip_only(user=Depends(require_membership("VIPä¼šå‘˜"))):
    return {"message": "VIPä¸“äº«å†…å®¹", "user": user.username}
```

## ğŸ“– æ ¸å¿ƒAPIæ–‡æ¡£

> **å‰ç¼€è¯´æ˜**: æ‰€æœ‰APIéƒ½éœ€è¦åŠ ä¸Šå‰ç¼€ `/user_center`ï¼ˆå¦‚æœåœ¨é›†æˆæ—¶è®¾ç½®äº†prefixï¼‰

### ğŸ” è´¦å·å¯†ç è®¤è¯

#### 1. ç”¨æˆ·æ³¨å†Œ
- **URL**: `/api/account/normal/register/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "username": "testuser",
    "password": "password123",
    "role_name": "user",      // å¯é€‰ï¼Œé»˜è®¤ "l0"
    "app_name": "your_app"    // å¯é€‰ï¼Œé»˜è®¤ "app0"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "testuser",
            "nickname": "testuser",
            "roles": [...],
            "email": "testuser",
            "phone": "testuser"
        }
    }
}
```

#### 2. ç”¨æˆ·ç™»å½•
- **URL**: `/api/account/normal/login/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "username": "testuser",
    "password": "password123"
}

// å“åº”ç¤ºä¾‹ï¼ˆåŒæ³¨å†Œæ ¼å¼ï¼‰
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "testuser",
            "nickname": "testuser",
            "roles": [...],
            "email": "testuser",
            "phone": "testuser"
        }
    }
}
```

#### 3. è¡¨å•ç™»å½•
- **URL**: `/api/account/normal/login-form/`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `application/x-www-form-urlencoded`

```
username=testuser&password=password123&grant_type=password
```

### ğŸ“± æ‰‹æœºå·è®¤è¯

#### 1. å‘é€éªŒè¯ç 
- **URL**: `/api/account/phone/send-verification-code/`
- **æ–¹æ³•**: `POST`

```json
{
    "phone": "13800138000"
}
```

#### 2. æ‰‹æœºå·æ³¨å†Œæˆ–ç™»å½•ï¼ˆæ¨èï¼‰
- **URL**: `/api/account/phone/register-or-login-phone/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "phone": "13800138000",
    "sms_code": "123456",
    "referer_id": 123,        // å¯é€‰ï¼Œé‚€è¯·äººID
    "app_name": "your_app"    // å¯é€‰
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "refresh_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
        "user_info": {
            "username": "13800138000",
            "nickname": "13800138000",
            "roles": [...],
            "email": null,
            "phone": "13800138000"
        }
    }
}
```

#### 3. æ›´æ¢ç»‘å®šæ‰‹æœºå·
- **URL**: `/api/account/phone/change-phone/`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```json
{
    "new_phone": "13900139000",
    "sms_code": "123456"
}
```

### ğŸ”— å¾®ä¿¡ç™»å½•è®¤è¯

#### 1. è·å–ç™»å½•äºŒç»´ç URL
- **URL**: `/api/account/wechat/qr-login/get-qrcode`
- **æ–¹æ³•**: `POST`

```json
{
    "WECHAT_REDIRECT_URI": "https://your-domain.com/callback"
}
```

#### 2. å¾®ä¿¡ä¸€é”®ç™»å½•
- **URL**: `/api/account/wechat/qr-login/login/`
- **æ–¹æ³•**: `POST`

```json
{
    "code": "å¾®ä¿¡è¿”å›çš„æˆæƒç ",
    "app_name": "your_app"
}
```

### ğŸ« JWT Tokenç®¡ç†

#### 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- **URL**: `/api/token/get-current-user/`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```bash
# Headers
Authorization: Bearer your_access_token
```

#### 2. åˆ·æ–°è®¿é—®ä»¤ç‰Œ
- **URL**: `/api/token/refresh-token/`
- **æ–¹æ³•**: `POST`

```json
{
    "refresh_token": "your_refresh_token"
}
```

### ğŸ‘¥ ç”¨æˆ·æƒé™ç®¡ç†API

#### 1. åˆ†é…æˆ–åˆ›å»ºè§’è‰²
- **URL**: `/api/roles/assign-role/`
- **æ–¹æ³•**: `POST`

```json
{
    "user_id": 1,
    "role_name": "admin",
    "app_name": "your_app"
}
```

#### 2. éªŒè¯ç”¨æˆ·è§’è‰²
- **URL**: `/api/roles/role-auth/`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```json
{
    "role_name": "admin",
    "app_name": "your_app"
}
```

### ğŸšª ç”¨æˆ·ç™»å‡º

#### é€€å‡ºç™»å½•
- **URL**: `/api/account/logout`
- **æ–¹æ³•**: `GET`

## ğŸ’ ä¼šå‘˜ä½“ç³»

### ğŸ¯ ä¼šå‘˜ä½“ç³»æ¦‚è¿°

ä¼šå‘˜ä½“ç³»æ˜¯ v2.1.0 çš„æ ¸å¿ƒæ–°åŠŸèƒ½ï¼Œæä¾›å®Œæ•´çš„æ—¶é—´æ§åˆ¶ã€æƒé™æ•´åˆå’Œè‡ªåŠ¨åŒ–ç®¡ç†ï¼š

- **â° æ—¶é—´æ§åˆ¶**: ä¼šå‘˜åœ¨æŒ‡å®šæ—¶é—´æ®µå†…æœ‰æ•ˆï¼Œè‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†è¿‡æœŸä¼šå‘˜
- **ğŸ”„ æƒé™æ•´åˆ**: ä¸ç°æœ‰è§’è‰²æƒé™ç³»ç»Ÿå®Œç¾æ•´åˆï¼Œæ”¯æŒç»„åˆä½¿ç”¨
- **ğŸ¤– è‡ªåŠ¨åŒ–ç®¡ç†**: å®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šå‘˜ï¼Œæ”¯æŒä¼šå‘˜ç»Ÿè®¡å’Œç›‘æ§
- **ğŸ’° çµæ´»å®šä»·**: æ”¯æŒä¸åŒä¼šå‘˜ç±»å‹çš„å·®å¼‚åŒ–å®šä»·å’Œæ—¶é•¿

### ğŸ“Š æ ¸å¿ƒæ•°æ®ç»“æ„

#### ä¼šå‘˜ç±»å‹è¡¨ (membership_types)
```sql
CREATE TABLE membership_types (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    duration_days INTEGER NOT NULL,
    price INTEGER NOT NULL,  -- ä»·æ ¼ï¼ˆåˆ†ä¸ºå•ä½ï¼‰
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### ç”¨æˆ·ä¼šå‘˜è¡¨ (memberships)
```sql
CREATE TABLE memberships (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    membership_type_id INTEGER REFERENCES membership_types(id),
    start_time TIMESTAMP NOT NULL,
    end_time TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'active',  -- active/expired/suspended/cancelled
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    notes TEXT
);
```

### ğŸ”§ ä¼šå‘˜ç±»å‹ç®¡ç†API

#### 1. åˆ›å»ºä¼šå‘˜ç±»å‹
- **URL**: `/membership-types/`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "name": "VIPä¼šå‘˜",
    "description": "VIPä¼šå‘˜äº«å—æ‰€æœ‰é«˜çº§åŠŸèƒ½",
    "duration_days": 30,
    "price": 9900,  // 99å…ƒï¼ˆä»¥åˆ†ä¸ºå•ä½ï¼‰
    "role_names": ["vip_user", "premium_access"],
    "app_name": "myapp"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "id": 1,
        "name": "VIPä¼šå‘˜",
        "description": "VIPä¼šå‘˜äº«å—æ‰€æœ‰é«˜çº§åŠŸèƒ½",
        "duration_days": 30,
        "price": 9900,
        "is_active": true,
        "created_at": "2024-12-20T10:00:00Z"
    },
    "message": "ä¼šå‘˜ç±»å‹åˆ›å»ºæˆåŠŸ"
}
```

#### 2. è·å–ä¼šå‘˜ç±»å‹åˆ—è¡¨
- **URL**: `/membership-types/`
- **æ–¹æ³•**: `GET`

#### 3. æ›´æ–°/åˆ é™¤ä¼šå‘˜ç±»å‹
- **URL**: `/membership-types/{membership_type_id}`
- **æ–¹æ³•**: `PUT` / `DELETE`

### ğŸ‘¥ ç”¨æˆ·ä¼šå‘˜ç®¡ç†API

#### 1. è´­ä¹°ä¼šå‘˜
- **URL**: `/memberships/purchase`
- **æ–¹æ³•**: `POST`

```json
// è¯·æ±‚å‚æ•°
{
    "user_id": 1,
    "membership_type_id": 1,
    "notes": "è´­ä¹°VIPä¼šå‘˜"
}

// å“åº”ç¤ºä¾‹
{
    "code": 200,
    "data": {
        "id": 1,
        "user_id": 1,
        "membership_type_id": 1,
        "membership_type_name": "VIPä¼šå‘˜",
        "start_time": "2024-12-20T10:00:00Z",
        "end_time": "2025-01-19T10:00:00Z",
        "status": "active",
        "is_valid": true
    },
    "message": "ä¼šå‘˜å¼€é€šæˆåŠŸ"
}
```

#### 2. è·å–æˆ‘çš„ä¼šå‘˜
- **URL**: `/memberships/my`
- **æ–¹æ³•**: `GET`
- **éœ€è¦è®¤è¯**: âœ…

### ğŸ›¡ï¸ ä¼šå‘˜æƒé™éªŒè¯

#### æƒé™è£…é¥°å™¨ä½¿ç”¨

```python
from svc_user_auth_zxw.apis.api_ä¼šå‘˜æƒé™éªŒè¯ import require_membership, require_membership_or_role

# çº¯ä¼šå‘˜æƒé™æ§åˆ¶
@app.get("/vip-content")
async def get_vip_content(user=Depends(require_membership("VIPä¼šå‘˜"))):
    return {"message": "è¿™æ˜¯VIPä¸“äº«å†…å®¹", "user": user.username}

# ä¼šå‘˜+åº”ç”¨æƒé™æ§åˆ¶
@app.get("/app-vip-content")
async def get_app_vip_content(user=Depends(require_membership("VIPä¼šå‘˜", "myapp"))):
    return {"message": "è¿™æ˜¯myappåº”ç”¨ä¸­çš„VIPä¸“äº«å†…å®¹"}

# ä¼šå‘˜æˆ–è§’è‰²æƒé™ï¼ˆä»»ä¸€å³å¯ï¼‰
@app.get("/premium-or-admin-content")
async def get_premium_or_admin_content(
    user=Depends(require_membership_or_role("Premiumä¼šå‘˜", "admin", "myapp"))
):
    return {"message": "Premiumä¼šå‘˜æˆ–adminè§’è‰²å¯è®¿é—®"}
```

#### APIéªŒè¯æ¥å£

- **URL**: `/membership-auth/verify`
- **æ–¹æ³•**: `POST`
- **éœ€è¦è®¤è¯**: âœ…

```json
{
    "membership_type_name": "VIPä¼šå‘˜",
    "role_name": "vip_user",
    "app_name": "myapp"
}
```

### â° å®šæ—¶ä»»åŠ¡å’Œè‡ªåŠ¨åŒ–ç®¡ç†

å®šæ—¶ä»»åŠ¡å·²é›†æˆåˆ°FastAPIåº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- ğŸ”„ æ¯å°æ—¶æ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸä¼šå‘˜
- ğŸ“Š ç»Ÿè®¡ä¼šå‘˜ä½¿ç”¨æƒ…å†µ
- ğŸš¨ ç›‘æ§å¼‚å¸¸çŠ¶æ€ä¼šå‘˜

#### æ‰‹åŠ¨ç®¡ç†å·¥å…·

```python
from svc_user_auth_zxw.tools.membership_cleanup import cleanup_expired_memberships

# è¯•è¿è¡Œï¼ˆä¸å®é™…ä¿®æ”¹æ•°æ®ï¼‰
result = await cleanup_expired_memberships(dry_run=True)

# å®é™…æ‰§è¡Œæ¸…ç†
result = await cleanup_expired_memberships(dry_run=False)
```

#### å‘½ä»¤è¡Œå·¥å…·

```bash
# æ¸…ç†è¿‡æœŸä¼šå‘˜
python -m svc_user_auth_zxw.tools.membership_cleanup --cleanup

# è¯•è¿è¡Œæ¨¡å¼
python -m svc_user_auth_zxw.tools.membership_cleanup --cleanup --dry-run

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
python -m svc_user_auth_zxw.tools.membership_cleanup --stats

# æŸ¥çœ‹å³å°†è¿‡æœŸçš„ä¼šå‘˜ï¼ˆ7å¤©å†…ï¼‰
python -m svc_user_auth_zxw.tools.membership_cleanup --expiring 7
```

## ğŸ›¡ï¸ æƒé™ç®¡ç†

### 1. æƒé™ä½“ç³»æ¦‚è¿°

ç³»ç»Ÿæ”¯æŒä¸¤ç§æƒé™ç±»å‹ï¼š

- **è§’è‰²æƒé™**: åŸºäºç”¨æˆ·è§’è‰²çš„ä¼ ç»Ÿæƒé™ç®¡ç†
- **ä¼šå‘˜æƒé™**: åŸºäºä¼šå‘˜ç±»å‹å’Œæ—¶é—´çš„æƒé™ç®¡ç†

### 2. è§’è‰²æƒé™è£…é¥°å™¨

```python
from svc_user_auth_zxw import require_role, require_roles, get_current_user

# å•ä¸ªè§’è‰²éªŒè¯
@app.get("/admin-only")
async def admin_endpoint(user=Depends(require_role("admin", "your_app"))):
    return {"message": "åªæœ‰adminå¯ä»¥è®¿é—®"}

# å¤šä¸ªè§’è‰²éªŒè¯ï¼ˆä»»ä¸€å³å¯ï¼‰
@app.get("/multi-roles")
async def multi_roles_endpoint(user=Depends(require_roles(["admin", "moderator"], "your_app"))):
    return {"message": "adminæˆ–moderatorå¯ä»¥è®¿é—®"}

# è·å–å½“å‰ç”¨æˆ·
@app.get("/profile")
async def get_profile(current_user=Depends(get_current_user)):
    return {"user": current_user.username}
```

### 3. æƒé™ç»„åˆä½¿ç”¨

```python
# å¤æ‚çš„æƒé™ç»„åˆï¼šå¿…é¡»æ˜¯VIPä¼šå‘˜ä¸”æœ‰adminè§’è‰²
@app.get("/super-admin")
async def super_admin_endpoint(
    vip_user=Depends(require_membership("VIPä¼šå‘˜")),
    admin_user=Depends(require_role("admin", "your_app"))
):
    # åªæœ‰åŒæ—¶æ»¡è¶³VIPä¼šå‘˜å’Œadminè§’è‰²çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
    return {"message": "è¶…çº§ç®¡ç†å‘˜ä¸“äº«åŠŸèƒ½"}
```

### 4. åŠ¨æ€æƒé™ç®¡ç†

```python
from svc_user_auth_zxw.apis.api_ç”¨æˆ·æƒé™_å¢åŠ  import add_new_role, delete_role, delete_roles

# æ–°å¢æƒé™
await add_new_role(
    è¯·æ±‚_åˆ†é…æˆ–åˆ›å»ºè§’è‰²(
        user_id=user.id,
        role_name="gen_content_1",
        app_name="your_app"
    ),
    db=db
)

# åˆ é™¤å•ä¸ªè§’è‰²
await delete_role(user_id=1, role_name="admin", db=db_session)

# æ‰¹é‡åˆ é™¤è§’è‰²
await delete_roles(user_id=1, role_names=["admin", "editor"], db=db_session)
```

## ğŸ¨ å‰ç«¯é›†æˆ

### 1. Vue-Element-Plus-Admin æ¡†æ¶é›†æˆ

è¯¥åº“å·²é€‚é… Vue-Element-Plus-Admin æ¡†æ¶çš„ API æ ‡å‡†æ ¼å¼ï¼š

```javascript
// API è¿”å›æ ¼å¼
{
    "code": 200,
    "data": {
        // å®é™…æ•°æ®
    }
}
```

### 2. å‰ç«¯ç™»å½•ç¤ºä¾‹

```javascript
// ç™»å½•å‡½æ•°
async function login(username, password) {
    const response = await fetch('/user_center/api/account/normal/login/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username, password })
    });
    
    const result = await response.json();
    if (result.code === 200) {
        localStorage.setItem('access_token', result.data.access_token);
        localStorage.setItem('refresh_token', result.data.refresh_token);
        return result.data.user_info;
    }
    throw new Error(result.data);
}

// è¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(config => {
    const token = localStorage.getItem('access_token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

// å“åº”æ‹¦æˆªå™¨ï¼ˆè‡ªåŠ¨åˆ·æ–°Tokenï¼‰
axios.interceptors.response.use(
    response => response,
    async error => {
        if (error.response?.status === 401) {
            const refreshToken = localStorage.getItem('refresh_token');
            if (refreshToken) {
                try {
                    const response = await axios.post('/user_center/api/token/refresh-token/', {
                        refresh_token: refreshToken
                    });
                    const { access_token, refresh_token } = response.data.data;
                    localStorage.setItem('access_token', access_token);
                    localStorage.setItem('refresh_token', refresh_token);
                    // é‡è¯•åŸè¯·æ±‚
                    return axios.request(error.config);
                } catch {
                    // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                    localStorage.clear();
                    window.location.href = '/login';
                }
            }
        }
        return Promise.reject(error);
    }
);
```

### 3. UniAppé›†æˆç¤ºä¾‹

é¡¹ç›®æä¾›äº†å®Œæ•´çš„UniAppæ‰‹æœºå·ç™»å½•é¡µé¢ç¤ºä¾‹ï¼Œä½äº `uniappå‰ç«¯é¡µé¢demo/` ç›®å½•ã€‚

## ğŸš€ é«˜çº§åŠŸèƒ½

### 1. çŸ­ä¿¡éªŒè¯ç 

åº“é›†æˆäº†é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ï¼Œæ”¯æŒéªŒè¯ç å‘é€å’ŒéªŒè¯ï¼š

```python
# é…ç½®é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡
class AliyunSMS:
    ali_access_key_id = "your_access_key_id"
    ali_access_key_secret = "your_access_key_secret"
    sign_name = "ä½ çš„ç­¾å"
    template_code = "SMS_123456789"
```

### 2. é‚€è¯·ç³»ç»Ÿ

æ”¯æŒç”¨æˆ·é‚€è¯·åŠŸèƒ½ï¼Œæ³¨å†Œæ—¶å¯ä»¥æŒ‡å®šé‚€è¯·äººï¼š

```json
{
    "phone": "13800138000",
    "sms_code": "123456",
    "referer_id": 123  // é‚€è¯·äººç”¨æˆ·ID
}
```

### 3. ä¼šå‘˜åˆ°æœŸæé†’

```python
from svc_user_auth_zxw.tools.membership_cleanup import get_expiring_memberships

# è·å–å³å°†è¿‡æœŸçš„ä¼šå‘˜ï¼ˆ7å¤©å†…ï¼‰
expiring_memberships = await get_expiring_memberships(days=7)

# å‘é€åˆ°æœŸæé†’é‚®ä»¶
for membership in expiring_memberships:
    await send_expiry_reminder(membership.user.email, membership)
```

## âš ï¸ é”™è¯¯å¤„ç†

### 1. ç»Ÿä¸€é”™è¯¯æ ¼å¼

```json
{
    "code": 400,
    "data": "å…·ä½“é”™è¯¯ä¿¡æ¯æè¿°"
}
```

### 2. å¸¸è§é”™è¯¯ä»£ç 

#### HTTPçŠ¶æ€ç 
- `200`: æˆåŠŸ
- `400`: è¯·æ±‚å‚æ•°é”™è¯¯
- `401`: æœªæˆæƒï¼ˆTokenæ— æ•ˆæˆ–è¿‡æœŸï¼‰
- `403`: æƒé™ä¸è¶³
- `404`: èµ„æºæœªæ‰¾åˆ°
- `500`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

#### ä¸šåŠ¡é”™è¯¯ä»£ç 
- **è®¤è¯ç›¸å…³**: `ç”¨æˆ·åå·²æ³¨å†Œ`ã€`æ— æ•ˆçš„ç”¨æˆ·åæˆ–å¯†ç `ã€`tokenéªŒè¯å¤±è´¥`
- **éªŒè¯ç ç›¸å…³**: `éªŒè¯ç å‘é€å¤±è´¥`ã€`éªŒè¯ç éªŒè¯å¤±è´¥`ã€`éªŒè¯ç å·²è¿‡æœŸ`
- **æƒé™ç›¸å…³**: `è§’è‰²æœªæ‰¾åˆ°`ã€`æƒé™ä¸è¶³`ã€`åº”ç”¨æœªæ‰¾åˆ°`
- **ä¼šå‘˜ç›¸å…³**: `ä¼šå‘˜ç±»å‹ä¸å­˜åœ¨`ã€`ä¼šå‘˜å·²è¿‡æœŸ`ã€`ä¼šå‘˜æƒé™ä¸è¶³`

### 3. å‰ç«¯é”™è¯¯å¤„ç†ç¤ºä¾‹

```javascript
// Axios å“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
    response => {
        // æˆåŠŸå“åº”
        if (response.data.code === 200) {
            return response.data.data;
        }
        // ä¸šåŠ¡é”™è¯¯
        throw new Error(response.data.data);
    },
    error => {
        // HTTPé”™è¯¯å¤„ç†
        if (error.response?.status === 401) {
            // Tokenè¿‡æœŸï¼Œè·³è½¬ç™»å½•
            localStorage.clear();
            window.location.href = '/login';
        } else if (error.response?.status === 403) {
            // æƒé™ä¸è¶³
            ElMessage.error('æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        } else if (error.response?.status === 400) {
            // ä¸šåŠ¡é€»è¾‘é”™è¯¯
            ElMessage.error(error.response?.data?.data || 'è¯·æ±‚å‚æ•°é”™è¯¯');
        } else if (error.response?.status === 500) {
            // æœåŠ¡å™¨é”™è¯¯
            ElMessage.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
        return Promise.reject(error);
    }
);
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¿…éœ€ç¯å¢ƒå˜é‡
export USER_CENTER_DATABASE_URL="postgresql+asyncpg://user:pass@host:port/db"
export REDIS_URL_AUTH="redis://:password@host:port/db"

# å¯é€‰ç¯å¢ƒå˜é‡
export WECHAT_APP_ID="your_wechat_app_id"
export WECHAT_APP_SECRET="your_wechat_app_secret"
export ALIYUN_ACCESS_KEY_ID="your_access_key_id"
export ALIYUN_ACCESS_KEY_SECRET="your_access_key_secret"
```

### 2. ç”Ÿäº§ç¯å¢ƒé…ç½®

```python
# ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹
class JWT:
    SECRET_KEY = os.environ.get("JWT_SECRET_KEY", "your-production-secret-key")
    ALGORITHM = "HS256"
    expire_time = timedelta(hours=1)  # ç”Ÿäº§ç¯å¢ƒå»ºè®®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´

# CORS é…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://your-domain.com"],  # ç”Ÿäº§ç¯å¢ƒæŒ‡å®šå…·ä½“åŸŸå
    allow_credentials=True,
    allow_methods=["GET", "POST", "DELETE", "PUT"],
    allow_headers=["*"],
)
```

### 3. æ•°æ®åº“è¿ç§»

```bash
# å®‰è£…Alembic
pip install alembic

# åˆå§‹åŒ–è¿ç§»ç¯å¢ƒ
alembic init alembic

# ç”Ÿæˆè¿ç§»æ–‡ä»¶
alembic revision --autogenerate -m "Initial migration"

# æ‰§è¡Œè¿ç§»
alembic upgrade head
```

### 4. Dockeréƒ¨ç½²ç¤ºä¾‹

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 5. æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_email ON users(email);

-- ä¼šå‘˜è¡¨ç´¢å¼•
CREATE INDEX idx_memberships_user_id ON memberships(user_id);
CREATE INDEX idx_memberships_end_time ON memberships(end_time);
CREATE INDEX idx_memberships_status ON memberships(status);

-- è§’è‰²è¡¨ç´¢å¼•
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
```

#### Redisç¼“å­˜é…ç½®
```python
# Redisè¿æ¥æ± é…ç½®
REDIS_CONFIG = {
    "host": "localhost",
    "port": 6379,
    "db": 0,
    "password": "your_password",
    "max_connections": 20,
    "retry_on_timeout": True,
    "socket_timeout": 5,
    "socket_connect_timeout": 5
}
```

### 6. ç›‘æ§å’Œæ—¥å¿—

#### åº”ç”¨ç›‘æ§
```python
import logging
from svc_user_auth_zxw.tools import logger

# é…ç½®æ—¥å¿—çº§åˆ«
logging.basicConfig(level=logging.INFO)

# è‡ªå®šä¹‰æ—¥å¿—å¤„ç†
@app.middleware("http")
async def log_requests(request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    
    logger.info(
        f"{request.method} {request.url} - "
        f"Status: {response.status_code} - "
        f"Time: {process_time:.3f}s"
    )
    return response
```

#### å¥åº·æ£€æŸ¥
```python
@app.get("/health")
async def health_check():
    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    try:
        # æ‰§è¡Œç®€å•æŸ¥è¯¢
        await db.execute("SELECT 1")
        db_status = "healthy"
    except Exception as e:
        db_status = f"unhealthy: {str(e)}"
    
    # æ£€æŸ¥Redisè¿æ¥
    try:
        await redis.ping()
        redis_status = "healthy"
    except Exception as e:
        redis_status = f"unhealthy: {str(e)}"
    
    return {
        "status": "ok",
        "database": db_status,
        "redis": redis_status,
        "version": "2.1.0"
    }
```

## ğŸ“ ç¤ºä¾‹é¡¹ç›®

å®Œæ•´çš„ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒé¡¹ç›®ä¸­çš„ `useExamples` ç›®å½•ï¼š

- `main.py`: FastAPI åº”ç”¨é›†æˆç¤ºä¾‹
- `api_æƒé™ç®¡ç†.py`: é«˜çº§æƒé™ç®¡ç†ç¤ºä¾‹
- `ä¼šå‘˜åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹.py`: ä¼šå‘˜ä½“ç³»å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

ä¼šå‘˜åŠŸèƒ½è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ï¼š
- `ä¼šå‘˜åŠŸèƒ½è¯´æ˜.md`: ä¼šå‘˜ä½“ç³»è¯¦ç»†åŠŸèƒ½è¯´æ˜å’Œä½¿ç”¨æ–‡æ¡£

## ğŸ‘¨â€ğŸ’» æŠ€æœ¯æ”¯æŒ

- **ä½œè€…**: å¼ è–›ä¼Ÿ (Zhang Xuewei)
- **é‚®ç®±**: shuiheyangguang@gmail.com
- **GitHub**: https://github.com/sunshineinwater/

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤Issueæˆ–è”ç³»ä½œè€…ã€‚

## ï¿½ï¿½ è®¸å¯è¯

MIT License
