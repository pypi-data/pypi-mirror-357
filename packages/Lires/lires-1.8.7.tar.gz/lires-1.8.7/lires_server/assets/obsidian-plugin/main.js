/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var x=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var A=(r,t)=>{for(var e in t)x(r,e,{get:t[e],enumerable:!0})},M=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of N(t))!R.call(r,s)&&s!==e&&x(r,s,{get:()=>t[s],enumerable:!(i=$(t,s))||i.enumerable});return r};var H=r=>M(x({},"__esModule",{value:!0}),r);var j={};A(j,{default:()=>_});module.exports=H(j);var c=require("obsidian");var C=class{constructor({baseUrlGetter:t=()=>"",tokenGetter:e=()=>"",sessionIDGetter:i=()=>""}){this._baseUrlGetter=t,this._tokenGetter=e,this._sessionIDGetter=i}get baseUrl(){return this._baseUrlGetter()}get token(){return this._tokenGetter()}get sessionID(){return this._sessionIDGetter()}async get(t,e={}){let i=new URL(`${this._baseUrlGetter()}${t}`);return Object.keys(e).forEach(s=>i.searchParams.append(s,e[s])),await this._fetch(i.toString(),{method:"GET"})}async post(t,e={}){let i=new FormData;for(let s in e){let n=e[s];n instanceof Array&&(n=JSON.stringify(n)),i.append(s,n)}return await this._fetch(`${this._baseUrlGetter()}${t}`,{method:"POST",body:i})}async put(t,e){let i=new FormData;return i.append("key",this._tokenGetter()),i.append("session_id",this._sessionIDGetter()),i.append("file",e),await this._fetch(`${this._baseUrlGetter()}${t}`,{method:"PUT",body:i})}async delete(t,e={}){let i=new FormData;for(let s in e){let n=e[s];n instanceof Array&&(n=JSON.stringify(n)),i.append(s,n)}return i.append("key",this._tokenGetter()),i.append("session_id",this._sessionIDGetter()),await this._fetch(`${this._baseUrlGetter()}${t}`,{method:"DELETE",body:i})}async _fetch(t,e){if(e===void 0&&(e={}),e.headers===void 0?e.headers=new Headers:typeof e.headers=="string"?e.headers=new Headers(e.headers):e.headers=new Headers(e.headers),e.headers.append("Authorization",`Bearer ${this._tokenGetter()}`),(e==null?void 0:e.method)==="GET"){let s=new URL(t);s.searchParams.append("session_id",this._sessionIDGetter()),t=s.toString()}else if((e==null?void 0:e.method)==="POST"||(e==null?void 0:e.method)==="PUT"||(e==null?void 0:e.method)==="DELETE")if(typeof e.body=="string")e.body=JSON.stringify({session_id:this._sessionIDGetter(),...JSON.parse(e.body)});else if(e.body instanceof FormData)e.body.has("session_id")||e.body.append("session_id",this._sessionIDGetter());else throw new Error("Not implemented body type");let i=await fetch(t,e);if(!i.ok)throw new Error(`Request failed with status ${i.status}`);return i}},G=C;var q={doc_type:"",has_file:!1,file_type:"",year:"0000",title:" ",author:" ",authors:[" "],publication:null,tags:[],uuid:" ",url:"about:blank",time_added:0,time_modified:0,bibtex:"",doc_size:0,note_linecount:0,has_abstract:!1},f=class{constructor(){this.parseMarkdown=(t,e,i,s)=>(e=e.replace(new RegExp("./misc/","g"),`${t}/misc/${i.uuid}?u=${s.id}&&fname=`),e)}init(t,e){let i=Math.random().toString(36).substring(2,15);return this._fetcher=new G({baseUrlGetter:t,tokenGetter:e,sessionIDGetter:()=>"obsidian-"+i}),this}async reqUserInfo(){return await this._fetcher.post("/api/auth").then(t=>t.json())}async reqDatapointSummary(t){try{return await this._fetcher.get(`/api/datainfo/${t}`).then(e=>e.json())}catch(e){return console.log(e),q}}async reqDatapointAbstract(t){return await this._fetcher.get(`/api/datainfo-supp/abstract/${t}`).then(e=>e.text())}async reqDatapointNote(t){return await this._fetcher.get(`/api/datainfo-supp/note/${t}`).then(e=>e.text())}};var O={endpoint:"",credential:""},E=new Map;async function L(r,t){let e=r.map(async i=>{if(!E.has(i)){let s=await t.reqDatapointSummary(i);s&&E.set(i,s)}return E.get(i)});return await Promise.all(e)}var _=class extends c.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new P(this.app,this)),this.api=new f().init(()=>this.settings.endpoint,()=>this.settings.credential),console.log("loading Lires plugin, time: ",Date.now()),this.api.reqUserInfo().then(t=>{this.userInfo=t}),this.registerMarkdownCodeBlockProcessor("lires-cite",(t,e,i)=>{let s=t.split(`
`).filter(n=>n.length>0);L(s,this.api).then(n=>{for(let u of n)u&&e.appendChild(F(this,u));let a=document.createElement("div");a.style.width="100%",a.style.display="flex",a.style.paddingRight="1em",a.style.justifyContent="flex-end",a.appendChild(g({text:"details",clickHandler:u=>{new k(this,s).open()}})),e.appendChild(a)})}),this.registerMarkdownCodeBlockProcessor("lires-ref",(t,e,i)=>{let s=t.split(`
`).filter(n=>n.length>0);L(s,this.api).then(n=>{for(let a of n)a&&e.appendChild(v(this,a))})})}onunload(){}async loadSettings(){this.settings=Object.assign({},O,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},I=class extends c.Modal{constructor(t,e){super(t),this.data=e}onOpen(){let{contentEl:t}=this,e=document.createElement("textarea");e.value=this.data.bibtex,e.style.width="100%",e.style.height="100%",e.style.minHeight="300px",e.style.resize="none",e.readOnly=!0,t.appendChild(e)}onClose(){let{contentEl:t}=this;t.empty()}},k=class extends c.Modal{constructor(t,e){super(t.app),this.uids=e,this.plugin=t}onOpen(){let{contentEl:t}=this;L(this.uids,this.plugin.api).then(e=>{for(let i of e)i&&t.appendChild(v(this.plugin,i))})}onClose(){let{contentEl:t}=this;t.empty()}},P=class extends c.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new c.Setting(t).setName("Endpoint").setDesc("The url of the Lires endpoint.").addText(e=>e.setPlaceholder("https://example.com:8080").setValue(this.plugin.settings.endpoint).onChange(async i=>{this.plugin.settings.endpoint=i,await this.plugin.saveSettings()})),new c.Setting(t).setName("Credential").setDesc("It's a secret").addText(e=>e.setPlaceholder("Enter your secret").setValue(this.plugin.settings.credential).onChange(async i=>{this.plugin.settings.credential=i,await this.plugin.saveSettings()}))}};function g({url:r="",text:t="",clickHandler:e=null,startBracket:i="[",endBracket:s="] "}={}){let n=document.createElement("span");n.classList.add("lires-cite-link");let a=document.createElement("a");return a.classList.add("lires-cite-link"),a.innerText=t,r&&(a.href=r),e&&(a.onclick=e),n.appendChild(document.createTextNode(i)),n.appendChild(a),n.appendChild(document.createTextNode(s)),n}function F(r,t){if(!t.uuid.trim()){let u=document.createElement("div");return u.innerText="Failed to load data",u}let e=document.createElement("div");e.classList.add("lires-cite-line");let i=document.createElement("span");i.classList.add("lires-cite-uuid"),i.innerText=t.uuid;let s=document.createElement("span");s.innerText="\u2022",s.style.marginRight="0.5em",e.appendChild(s);let n=document.createElement("span");n.classList.add("lires-cite"),n.innerText=t.author+` (${t.year}) ${t.title}`,n.style.marginTop="0em";let a=document.createElement("div");return a.style.display="flex",a.style.flexDirection="row",a.appendChild(s),a.appendChild(n),e.appendChild(i),e.appendChild(a),e}function v(r,t){let e=document.createElement("div");if(!t.uuid.trim()){let n=document.createElement("div");return n.innerText="Failed to load data",n.style.color="red",n.style.fontWeight="bold",n.style.margin="1em",e.appendChild(n),e}let i=n=>{let a=document.createElement("div");a.classList.add("lires-ref");let u=document.createElement("div");u.classList.add("lires-ref-uuid"),u.innerText="lires:"+n.uuid,a.appendChild(u);let b=document.createElement("h3");b.classList.add("lires-ref-title"),b.innerText=n.title,a.appendChild(b);let l=document.createElement("div");if(l.classList.add("lires-ref-info"),l.style.marginLeft="1em",l.style.marginTop="0.5em",n.publication){let o=document.createElement("span");o.classList.add("lires-ref-publication"),o.innerText=`(${n.year}) `+n.publication,l.appendChild(o),l.appendChild(document.createElement("br"))}let w=document.createElement("span");w.classList.add("lires-ref-authors");for(let o of n.authors){let p=document.createElement("span");p.classList.add("lires-ref-author"),p.innerText=o,o!==n.authors[n.authors.length-1]&&(p.innerText+="; "),w.appendChild(p)}l.appendChild(w),l.appendChild(document.createElement("br")),l.appendChild(g({url:r.settings.endpoint+"#reader/"+n.uuid,text:"reader"})),n.has_file&&l.appendChild(g({url:r.settings.endpoint+"/doc/"+n.uuid+"?u="+r.userInfo.id,text:"doc"})),n.url&&l.appendChild(g({url:n.url,text:"url"})),l.appendChild(g({text:"bibtex",clickHandler:o=>{new I(r.app,n).open()}}));let y=document.createElement("a");y.classList.add("lires-ref-reload"),y.innerText="reload",y.onclick=()=>{s()},l.appendChild(y),a.appendChild(l);function S(){let o=document.createElement("details");o.classList.add("lires-ref-detail");let p=document.createElement("summary");p.innerText="Abstract",o.appendChild(p);let d=document.createElement("p");d.classList.add("lires-ref-detail");function D(h){!h.target||!(h.target instanceof HTMLDetailsElement)||h.target.open&&(d.innerHTML="Loading...",r.api.reqDatapointAbstract(n.uuid).then(m=>{m!==""?d.innerText=m:d.innerText="Not available"}))}return o.addEventListener("toggle",D),o.appendChild(d),o}function U(){let o=document.createElement("details");o.classList.add("lires-ref-detail");let p=document.createElement("summary");p.innerText="Note",o.appendChild(p);let d=document.createElement("div");d.classList.add("lires-ref-detail");function D(h){!h.target||!(h.target instanceof HTMLDetailsElement)||h.target.open&&(d.innerHTML="Loading...",d.style.maxWidth="100%",r.api.reqDatapointNote(n.uuid).then(m=>{m!==""?(d.innerHTML="",m=r.api.parseMarkdown(r.settings.endpoint,m,n,r.userInfo),c.MarkdownRenderer.render(r.app,m,d,"__none_exist__",r)):d.innerText="Not available"}))}return o.addEventListener("toggle",D),o.appendChild(d),o}let T=document.createElement("div");return n.has_abstract&&T.appendChild(S()),n.note_linecount&&T.appendChild(U()),a.appendChild(T),a},s=()=>{let n=t.uuid;r.api.reqDatapointSummary(n).then(a=>{a&&(e.innerHTML="",E.set(n,a),e.appendChild(i(a)))})};return e.appendChild(i(t)),e}
