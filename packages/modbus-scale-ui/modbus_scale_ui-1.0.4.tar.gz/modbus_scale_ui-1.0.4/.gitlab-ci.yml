default:
    image: python:3.9
    cache:
        paths:
            - .pip-cache/
    before_script:
        - python --version
        - pip install --upgrade pip
        - pip install build twine

stages:
    - build
    - test
    - publish

variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

build:
    stage: build
    script:
        - python -m build
    artifacts:
        paths:
        - dist/

test:
    stage: test
    script:
        - pip install pytest
        - pip install dist/*.whl
        - pytest

publish:
    stage: publish
    script:
        - TWINE_PASSWORD=${LIVE_PYPI_TOKEN} TWINE_USERNAME=__token__ python -m twine upload dist/*
    rules:
        - if: $CI_COMMIT_TAG
