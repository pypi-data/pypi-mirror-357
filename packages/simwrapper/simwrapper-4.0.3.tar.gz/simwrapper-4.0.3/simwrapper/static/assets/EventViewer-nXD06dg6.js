import{r as E,g as r,R as l,j as v,M as A,d as L,H as I,h as c,n as F}from"./index-CjE8KAxu.js";import{G as R}from"./lil-gui.esm-D2cLj-mk.js";import{Y as S}from"./index-2NzccWut.js";import{w as $,p as x}from"./comlink-DESosX-g.js";import{u as j}from"./util-D5zhIDgq.js";import{C as _}from"./CollapsiblePanel-CffolN--.js";import{D as O}from"./DrawingTool-DJVu9FeR.js";import{L as Y}from"./LegendBox-WFrTUbWo.js";import{L as N}from"./LegendStore-CGgeb9zL.js";import{T as P}from"./TimeSlider-BH4vWbLU.js";import{D as W,S as V}from"./set-rtl-text-plugin-B3MMc2tB.js";import{I as B}from"./moving-icons-vehicles-layer-CP0zhT7l.js";import{D as G}from"./data-filter-C9NhyePn.js";import{Z as H}from"./ZoomButtons-BMMQ7ZQ_.js";import{D as q}from"./DashboardDataManager-Yw5BLsmx.js";import"./fxp-4YEvQr-_.js";import"./extends-CF3RwP-h.js";import"./geojson-layer-DkU3hrx3.js";import"./text-layer-B8VdqIk4.js";import"./path-layer-AcoYO7fT.js";import"./cut-by-mercator-bounds-DathOiyk.js";import"./solid-polygon-layer-xjHu0sJp.js";import"./index-DgdUD6UN.js";import"./icon-manager-DjrEr6Sd.js";import"./layer-extension-D5_TqVkA.js";import"./avro-Dd9UqmeZ.js";import"./RoadNetworkLoader.worker-CM-DT8Nw.js";import"./Coords-CQQjH_Bj.js";import"./group-DobYzF2-.js";import"./index-_doEQLKC.js";const U="/",X={vehicle:{x:0,y:0,width:256,height:256,mask:!1}};new G({filterSize:1});function Z({viewId:e=0,eventLayers:t=[],eventData:i=[],network:a={},dark:o=!1,colors:n=[[1,0,0],[.25,.25,1]],breakpoints:st=[0],mapIsIndependent:w=!1,simulationTime:m=18e3,projection:g="",dotsize:b=22,tick:C=0}){const[h,d]=E.useState(r.state.viewState),k=h.latitude||h.center&&h.center[1]||35,D=Math.cos(k*Math.PI/180);l[e]=()=>{d(r.state.viewState)};function T(s){s.latitude&&(s.center||(s.center=[0,0]),s.center[0]=s.longitude,s.center[1]=s.latitude,d(s),w||r.commit("setMapCamera",s))}function u(s){return s.index<0,null}const f=[];let p=0;i.forEach((s,M)=>{const y=m<s.timeRange[0]-5||m>s.timeRange[1]+5;y||p++,f.push(new B({data:{length:s.data.t0.length,attributes:{getTimeStart:s.data.t0,getTimeEnd:s.data.t1,getPathStart:s.data.p0,getPathEnd:s.data.p1,getColorCode:s.data.colors}},id:"vehicles"+M,iconMoving:"vehicle",iconStill:"vehicle",colorMap:[30,208,170,40,255,40,240,240,64,240,0,0],getSize:b,opacity:1,latitudeCorrectionFactor:D,currentTime:m,shadowEnabled:!1,iconAtlas:`${U}veh-curvy5.png`,iconMapping:X,sizeScale:1,billboard:!1,positionFormat:"XY",pickable:!1,depthTest:!0,autoHighlight:!1,highlightColor:[255,255,255,140],parameters:{depthTest:!1},visible:!y}))});const z=g&&g!=="Atlantis";return C==1&&console.log(m,p,i.length),v.createElement(W,{layers:f,controller:!0,useDevicePixels:!0,viewState:h,onViewStateChange:s=>T(s.viewState),pickingRadius:4,onClick:u,getTooltip:u},z&&v.createElement(V,{mapStyle:r.getters.mapStyle,preventStyleDiffing:!0,mapboxApiAccessToken:A}))}function J(e){return new Worker("/assets/WASMEventStreamer.worker-CpHz_pVL.js",{name:e?.name})}const K={messages:{en:{loading:"Loading data...",sorting:"Sorting into bins...",aggregate:"Summary",maxHeight:"3D Height",showDetails:"Show Details",selection:"Selection",areas:"Areas",count:"Count",promptCRS:`Enter the coordinate reference system, e.g. EPSG:25832

These coordinates are not in long/lat format. To fix this permanently, convert them to long/lat or add "# EPSG:xxxx" to your CSV header`},de:{loading:"Dateien laden...",sorting:"Sortieren...",aggregate:"Daten",maxHeight:"3-D Höhe",showDetails:"Details anzeigen",selection:"Ausgewählt",areas:"Orte",count:"Anzahl"}}},Q=L({name:"EventViewerPlugin",i18n:K,components:{CollapsiblePanel:_,DrawingTool:O,EventMap:Z,LegendBox:Y,TimeSlider:P,ZoomButtons:H},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean,datamanager:{type:Object}},data:()=>({tick:0,myDataManager:null,network:{source:new Float32Array,dest:new Float32Array,linkIds:[],projection:""},linkIdLookup:{},guiConfig:{speed:.1,size:16},viewId:"xyt-id-"+Math.floor(1e12*Math.random()),configId:"gui-config-"+Math.floor(1e12*Math.random()),timeLabels:[0,1],startTime:0,isAnimating:!1,simTime:0,timeFilter:[0,3600],colors:[[128,128,128],[128,128,128]],breakpoints:[0],range:[1/0,-1/0],timeRange:[1/0,-1/0],legendStore:null,standaloneYAMLconfig:{title:"",description:"",file:"",projection:"",thumbnail:"",radius:250,maxHeight:0,center:null,zoom:9},YAMLrequirementsXY:{file:""},columnLookup:[],gzipWorker:null,vizDetails:{title:"",description:"",file:"",projection:"",thumbnail:"",center:null,zoom:9},myState:{statusMessage:"",subfolder:"",yamlConfig:"",thumbnail:!1},eventLayers:[],eventData:[],isLoaded:!1,animator:null,guiController:null,resizer:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",ANIMATE_SPEED:.25,animationElapsedTime:0,animationClockTime:0}),computed:{fileApi(){return new I(this.fileSystem,r)},fileSystem(){const e=this.$store.state.svnProjects.filter(t=>t.slug===this.root);if(e.length===0)throw console.log("no such project"),Error;return e[0]},urlThumbnail(){return this.thumbnailUrl}},watch:{"$store.state.viewState"(){l[this.viewId]&&l[this.viewId]()}},methods:{setupLogoMover(){this.resizer=new ResizeObserver(this.moveLogo);const e=document.getElementById(`id-${this.viewId}`);this.resizer.observe(e)},moveLogo(){const e=document.getElementById(`${this.viewId}`),t=e?.querySelector(".mapboxgl-ctrl-bottom-left");if(t){const i=e.clientWidth>640?"280px":"36px";t.style.right=i}},setupGui(){this.guiController=new R({title:"VIEW SETTINGS",injectStyles:!0,width:200,container:document.getElementById(this.configId)||void 0});const e=this.guiController;e.add(this.guiConfig,"size",4,40,1).onChange(this.setConfig),e.add(this.guiConfig,"speed",[-2,-1,-.5,-.25,-.1,0,.1,.25,.5,1,2],1).onChange(this.setConfig)},async solveProjection(){if(!this.thumbnail){console.log("WHAT PROJECTION:");try{const e=await this.fileApi.getFileText(this.myState.subfolder+"/"+this.myState.yamlConfig);this.vizDetails=S.parse(e)}catch(e){console.error(e),this.$emit("error",""+e)}}},async getVizDetails(){if(this.config){this.validateYAML(),this.vizDetails=Object.assign({},this.config);return}new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig)?await this.loadStandaloneYAMLConfig():(console.log("NO YAML WTF"),this.setConfigForRawCSV())},setConfigForRawCSV(){let e="";this.vizDetails={title:"EVENTS: "+this.myState.yamlConfig,description:this.myState.yamlConfig,file:this.myState.yamlConfig,projection:e,center:this.vizDetails.center||void 0,zoom:this.vizDetails.zoom},this.$emit("title",this.vizDetails.title||this.vizDetails.file)},async loadStandaloneYAMLConfig(){if(this.fileApi)try{const e=this.myState.yamlConfig.indexOf("/")>-1?this.myState.yamlConfig:this.myState.subfolder+"/"+this.myState.yamlConfig,t=await this.fileApi.getFileText(e);this.standaloneYAMLconfig=Object.assign({},S.parse(t)),this.validateYAML(),this.setVizDetails()}catch{console.log("failed"),this.$emit("error",{type:c.ERROR,msg:"File not found",desc:`Could not find: ${this.myState.subfolder}/${this.myState.yamlConfig}`})}},validateYAML(){const e=new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig);let t;e?(console.log("has yaml"),t=this.standaloneYAMLconfig):(console.log("no yaml"),t=this.config);for(const i in this.YAMLrequirementsXY)i in t||this.$emit("error",{type:c.ERROR,msg:`EventViewer missing required key: ${i}`,desc:`Required keys: ${Object.keys(this.YAMLrequirementsXY)}`});t.radius==0&&this.$emit("error",{type:c.WARNING,msg:"Radius set to zero",desc:"Radius can not be zero, preset value used instead. "}),(t.zoom<5||t.zoom>20)&&this.$emit("error",{type:c.WARNING,msg:"Zoom is out of the recommended range ",desc:"Zoom levels should be between 5 and 20. "})},setVizDetails(){this.vizDetails=Object.assign({},this.vizDetails,this.standaloneYAMLconfig);const e=this.vizDetails.title?this.vizDetails.title:"EVENTS: "+this.vizDetails.file;this.$emit("title",e)},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const t=await(await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),i=j.arrayBufferToBase64(t);i&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${i})`)}catch(e){console.error(e)}},async streamEventFile(e){this.myState.statusMessage="Loading events: "+e,this.gzipWorker&&this.gzipWorker.terminate(),this.gzipWorker=new J;const t=$(this.gzipWorker),i=Object.assign({},this.fileSystem),a=[{viewer:"vehicleViewer"}];t.startStream({filename:e,layers:a,network:this.network,fsConfig:i},x(this.receiveDataFromEventStreamer))},async receiveDataFromEventStreamer(e){this.eventData=[...this.eventData,e],this.tick=1,await this.$nextTick(),this.tick=0},setFirstZoom(e,t){const i=.5*(e[0]+e[t*2-2]),a=.5*(e[1]+e[t*2-1]);Number.isFinite(i)&&Number.isFinite(a)&&r.commit("setMapCamera",Object.assign({},r.state.viewState,{longitude:i,latitude:a,zoom:10}))},toggleAnimation(){this.isAnimating=!this.isAnimating,this.isAnimating&&(this.animationElapsedTime=this.timeFilter[0]-this.timeRange[0],this.startTime=Date.now()-this.animationElapsedTime/this.guiConfig.speed,this.animate())},setConfig(){},setLegend(e,t){this.range[1]-this.range[0]!==0&&(this.legendStore=new N,this.legendStore.setLegendSection({section:"Legend",column:"Legend",values:e.map((i,a)=>{const o=t[a==0?a:a-1];let n=""+Math.round(1e6*o)/1e6;return a==0&&(n="< "+n),a==e.length-1&&(n="> "+n),{label:n,value:i}})}))},async loadNetwork(){if(!this.myDataManager)throw Error("event viewer: no datamanager");const{files:e}=await this.fileApi.getDirectory(this.subfolder);let t="";e.indexOf("network.avro")>-1?t="network.avro":t=this.vizDetails.file.replace("events.xml","network.xml"),console.log(t);const i=await this.myDataManager.getRoadNetwork(t,this.myState.subfolder,Object.assign({},this.vizDetails),null,!0);return this.vizDetails.projection=""+i.projection,{network:i}},async loadFiles(){const{network:e}=await this.loadNetwork();if(this.network=e,!this.vizDetails.center){let i=0,a=0,o=0;for(let n=0;n<this.network.source.length;n+=4096)i+=this.network.source[n],a+=this.network.source[n+1],o+=1;this.vizDetails.center=[i/o,a/o],r.commit("setMapCamera",{longitude:i/o||13.45,latitude:a/o||52.5,zoom:10})}let t=`${this.myState.subfolder}/${this.vizDetails.file}`;await this.streamEventFile(t)},handleTimeSliderValues(e){this.animationElapsedTime=e[0],this.simTime=this.animationElapsedTime,this.animationClockTime=this.animationElapsedTime+this.timeRange[0],this.timeFilter=e,this.timeLabels=[this.convertSecondsToClockTimeMinutes(e[0]),this.convertSecondsToClockTimeMinutes(e[1])]},animate(){if(!this.isAnimating)return;this.animationElapsedTime=this.guiConfig.speed*(Date.now()-this.startTime),this.animationClockTime=this.animationElapsedTime+this.timeRange[0],this.animationClockTime>this.timeRange[1]&&(this.startTime=Date.now(),this.animationElapsedTime=0);const e=3600;this.timeFilter=[this.animationClockTime,this.animationClockTime+e],this.simTime=this.animationClockTime,this.animator=window.requestAnimationFrame(this.animate)},convertSecondsToClockTimeMinutes(e){const t=Math.floor(e/3600),i=Math.floor((e-t*3600)/60),a=e-t*3600-i*60,o={h:`${t}`,m:`${i}`.padStart(2,"0"),s:`${a}`.padStart(2,"0")};return`${o.h}:${o.m}`}},async mounted(){this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig||"",this.myState.subfolder=this.subfolder,this.myDataManager=this.datamanager||new q(this.root,this.subfolder),await this.getVizDetails(),await this.buildThumbnail(),!this.thumbnail&&(this.setupLogoMover(),this.setupGui(),this.myState.statusMessage=`${this.$i18n.t("loading")}`,this.isLoaded||await this.loadFiles(),this.isLoaded=!0,this.myState.statusMessage="",this.timeRange=[0,86400],this.toggleAnimation())},beforeDestroy(){this.resizer?.disconnect(),l[this.viewId]=void 0,delete l[this.viewId];try{this.gzipWorker&&(this.gzipWorker.postMessage({terminate:!0}),this.gzipWorker.terminate()),this.guiController&&this.guiController.destroy()}catch(e){console.warn(e)}this.animator&&window.cancelAnimationFrame(this.animator),this.$store.commit("setFullScreen",!1)}});var tt=function(){var t=this,i=t._self._c;return t._self._setupProxy,i("div",{staticClass:"viz-plugin",attrs:{oncontextmenu:"return false",id:`id-${t.viewId}`}},[t.isLoaded&&!t.thumbnail?i("event-map",{staticClass:"map-layer",attrs:{viewId:t.viewId,eventData:t.eventData,eventLayers:t.eventLayers,network:t.network,linkIdLookup:t.linkIdLookup,timeFilter:t.timeFilter,dark:this.$store.state.isDarkMode,colors:this.colors,breakpoints:this.breakpoints,radius:this.guiConfig.radius,mapIsIndependent:!1,simulationTime:t.simTime,projection:t.vizDetails.projection,dotsize:t.guiConfig.size,tick:t.tick}}):t._e(),t.thumbnail?t._e():i("zoom-buttons",{attrs:{corner:"top-left"}}),i("div",{staticClass:"top-right"},[i("div",{staticClass:"gui-config",attrs:{id:t.configId}})]),i("div",{staticClass:"bottom-right"},[t.legendStore?i("div",{staticClass:"legend-area"},[i("legend-box",{attrs:{legendStore:t.legendStore}})],1):t._e()]),t.isLoaded?i("time-slider",{staticClass:"time-slider-area",attrs:{isPointInTime:!0,range:t.timeRange,activeTimeExtent:t.timeFilter,labels:t.timeLabels,isAnimating:t.isAnimating},on:{timeExtent:t.handleTimeSliderValues,toggleAnimation:t.toggleAnimation,drag:function(a){t.isAnimating=!1}}}):t._e(),!t.thumbnail&&t.myState.statusMessage?i("div",{staticClass:"message"},[i("p",{staticClass:"status-message"},[t._v(t._s(t.myState.statusMessage))])]):t._e()],1)},et=[],it=F(Q,tt,et,!1,null,"ec7e2408");const $t=it.exports;export{$t as default};
