<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced VPL4IP</title>
    <!-- Load Blockly core -->
    <script src="https://unpkg.com/blockly/blockly_compressed.js"></script>
    <!-- Load the default blocks -->
    <script src="https://unpkg.com/blockly/blocks_compressed.js"></script>
    <!-- Load a generator -->
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <!-- Load a message file -->
    <script src="https://unpkg.com/blockly/msg/en.js"></script>
    <style>
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      #blocklyDiv {
        flex: 3; /* Take up all remaining space */
        min-width: 400px; /* Minimum width of Blockly area */
      }
      #codeArea {
        flex: 1; /* Takes up one-fourth of the space */
        background-color: #f8f9fa;
        border-left: 1px solid #ccc;
        overflow: auto;
        font-family: monospace;
        padding: 10px;
        box-sizing: border-box;
      }
    </style>
    <style>
      #Control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px;
      }

      #Control label {
        margin-right: 5px;
      }
      #scaleInput {
        padding: 8px;
        width: auto;
      }
      button {
        padding: 8px 16px;
        cursor: pointer;
      }
      .separator {
        display: inline-block;
        height: 30px;
        width: 2px;
        background-color: #ccc;
        margin: 0 10px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div id="Control">
      <button id="loadUseCase" onclick="loadWorkspace()">load Use Case</button>
      <button id="logWorkspace" onclick="logWorkspace()">
        console.log(current workspace)
      </button>
      <span class="separator"></span>
      <button onclick="downloadWorkspaceSVG()">
        download workspace as SVG
      </button>
    </div>
    <div id="blocklyDiv"></div>
    <pre id="codeArea"></pre>
    
    <script>
      Blockly.defineBlocksWithJsonArray([
        {
          type: "read_image",
          message0: "read image ",
          args0: [],
          message1: "%1 path",
          args1: [
            {
              type: "field_input",
              name: "IMAGE_PATH",
              text: "image.tif",
            },
          ],
          message2: "%1 as gray? ",
          args2: [
            {
              type: "field_checkbox",
              name: "AS_GRAY",
              checked: true,
            },
          ],
          output: "IMAGE",
          colour: 260,
          tooltip: "Provides an image as output.",
          helpUrl: "",
        },
        {
          type: "gaussian_blur",
          message0: "gaussian blur %1",
          args0: [
            {
              type: "input_value",
              name: "IMAGE",
              check: "IMAGE",
            },
          ],
          message1: "%1 sigma",
          args1: [
            {
              type: "field_number",
              name: "SIGMA",
              value: 0.5,
              min: 0.0,
              precision: 0.1,
            },
          ],
          inputsInline: false,
          output: "IMAGE",
          colour: 260,
          tooltip: "Applies a Gaussian filter to the image.",
          helpUrl: "",
        },
        {
          type: "super_resolution",
          message0: "super resolution %1",
          args0: [
            {
              type: "input_value",
              name: "IMAGE",
              // check: "TORCH",
            },
          ],
          message1: "%1 scale factor",
          args1: [
            {
              type: "field_number",
              name: "scale",
              value: 2,
              min: 1,
              max: 10,
              precision: 1
            },
          ],
          inputsInline: false,
          output: null,
          colour: 120,
          tooltip: "",
          helpUrl: "",
        },
        {
          type: "local_contrast_enhancement",
          message0: "contrast enhance %1",
          args0: [
            {
              type: "input_value",
              name: "IMAGE",
            },
          ],
          output: "IMAGE",
          inputsInline: false,
          colour: 260,
          tooltip: "local_contrast_enhancement",
          helpUrl: "",
        },
      ]);

      var requiredImports = new Set();

      Blockly.Python.forBlock["read_image"] = function (block) {
        requiredImports.add("from im2im import Image, im2im, get_possible_metadata");
        requiredImports.add("from skimage.io import imread");
        var imageUrl = Blockly.Python.quote_(block.getFieldValue("IMAGE_PATH"));
        var asGray =
          block.getFieldValue("AS_GRAY") === "TRUE" ? "True" : "False";
        if (asGray) {
          var code = "Image(imread(" + imageUrl + ", as_gray=True), {**get_possible_metadata('skimage.gray'), 'image_data_type': 'uint8'})";
        } else {
          var code = "Image(imread(" + imageUrl + "), {**get_possible_metadata('skimage.rgb'), 'image_data_type': 'uint8'})";
        }
        var resultVar = Blockly.Python.nameDB_.getDistinctName(
          "raw_image",
          Blockly.VARIABLE_CATEGORY_NAME
        );
        var code = `${resultVar} = ${code}`;
        Blockly.Python.definitions_["define_" + resultVar] = code;

        return [`${resultVar}`, Blockly.Python.ORDER_NONE];
      };

      Blockly.Python.forBlock['gaussian_blur'] = function (block) {
        requiredImports.add("from skimage.filters import gaussian");
        var image =
          Blockly.Python.valueToCode(
            block,
            "IMAGE",
            Blockly.Python.ORDER_NONE
          ) || "None";
        var sigma = block.getFieldValue("SIGMA") || "0.5";
        var resultVar = Blockly.Python.nameDB_.getDistinctName(
          "out_im",
          Blockly.VARIABLE_CATEGORY_NAME
        );
        var convert_to = `in_im1 = im2im(${image}, 'skimage.before_gaussian')`;
        var operation = `e_gaussian_filtered = gaussian(in_im1.raw_image, sigma=${sigma})`;
        var convert_back = `${resultVar} = Image(e_gaussian_filtered, {**in_im1.metadata, 'image_data_type': 'float64(0to1)'})`;
        var code = `${convert_to}\n${operation}\n${convert_back}`;

        Blockly.Python.definitions_["define_" + resultVar] = code;
        return [`${resultVar}`, Blockly.Python.ORDER_NONE];
      };

      Blockly.Python.forBlock["super_resolution"] = function (block) {
        requiredImports.add("from im2im import Image, im2im");
        requiredImports.add("from api import super_resolution");
        var image =
          Blockly.Python.valueToCode(
            block,
            "IMAGE",
            Blockly.Python.ORDER_NONE
          ) || "None";
        var scale = block.getFieldValue("scale");
        var resultVar = Blockly.Python.nameDB_.getDistinctName(
          "out_im",
          Blockly.VARIABLE_CATEGORY_NAME
        );

        var convert_to = `in_im2 = im2im(${image}, 'torch.gpu')`;
        var operation = `e_super_res_image = super_resolution(in_im2.raw_image, ${scale})`;
        var convert_back = `${resultVar} = Image(e_super_res_image, in_im2.metadata)`;
        var code = `${convert_to}\n${operation}\n${convert_back}`;

        Blockly.Python.definitions_["define_" + resultVar] = code;
        return [`${resultVar}`, Blockly.Python.ORDER_NONE];
      };
      
      Blockly.Python.forBlock["local_contrast_enhancement"] = function (block) {
        requiredImports.add("from im2im import Image, im2im");
        var imports = "from skimage.exposure import equalize_adapthist";
        requiredImports.add(imports);
        var image =
          Blockly.Python.valueToCode(
            block,
            "IMAGE",
            Blockly.Python.ORDER_NONE
          ) || "None";
        
        inputVar = Blockly.Python.nameDB_.getDistinctName(
          "out_im",
          Blockly.VARIABLE_CATEGORY_NAME
        );
        var convert_to = `in_im3 = im2im(${image}, 'skimage.before_equalize_adapthist')`; 
        var operation = `e_contrast_enhanced = equalize_adapthist(in_im3.raw_image)`;
        var convert_back = `${inputVar} = Image(e_contrast_enhanced, {**in_im3.metadata, 'image_data_type': 'float64(0to1)'})`;
        var code = `${convert_to}\n${operation}\n${convert_back}`;
        Blockly.Python.definitions_["define_" + inputVar] = code;
        return [`${inputVar}`, Blockly.Python.ORDER_NONE];
      };
      
      function generateImports() {
        var imports = "";
        requiredImports.forEach(function (importStatement) {
          imports += importStatement + "\n";
        });
        return imports;
      }

      var workspace = Blockly.inject("blocklyDiv", {
        toolbox:
          '<xml id="toolbox" style="display: none">' +
          '<block type="read_image"></block>' +
          '<block type="gaussian_blur"></block>' +
          '<block type="super_resolution"></block>' +
          '<block type="local_contrast_enhancement"></block>' +
          "</xml>",
        zoom: {
          controls: true,
          wheel: true,
          startScale: 1.0,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2,
          pinch: true,
        },
        scrollbars: true,
        trashcan: true,
        rtl: true,
      });

      function updateCode() {
        var imports = generateImports();
        var code = Blockly.Python.workspaceToCode(workspace);
        document.getElementById("codeArea").textContent = imports + "\n" + code;
      }

      workspace.addChangeListener(updateCode);

      updateCode();
    </script>
    <script>
      function loadWorkspace(state) {
        var workspace = Blockly.getMainWorkspace();
        var savedState =
          '{"blocks":{"languageVersion":0,"blocks":[{"type":"local_contrast_enhancement","id":"!VWeNO0zet.{cO;+c,G}","x":580,"y":167,"inputs":{"IMAGE":{"block":{"type":"super_resolution","id":":bPjZ=4*2Ph{u$lX4-0s","fields":{"scale":2},"inputs":{"IMAGE":{"block":{"type":"gaussian_blur","id":"JzIwY/gM!p|=W4K`8.=l","fields":{"SIGMA":0.5},"inputs":{"IMAGE":{"block":{"type":"read_image","id":"~CNwMt_HbhC1riN%FD,z","fields":{"IMAGE_PATH":"image.tif","AS_GRAY":true}}}}}}}}}}}]}}';
        Blockly.serialization.workspaces.load(
          JSON.parse(savedState),
          workspace
        );
        workspace.zoomToFit();
      }

      function logWorkspace() {
        var workspace = Blockly.getMainWorkspace();
        const state = Blockly.serialization.workspaces.save(workspace);
        console.log(JSON.stringify(state));
      }

      function downloadWorkspaceSVG() {
        var svg = document.getElementsByClassName("blocklySvg")[0]; // Get the SVG element
        var styleElement = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "style"
        );
        styleElement.textContent = `.blocklyText { fill: #fff; }
                                  .blocklyEditableText>text { fill: #000; }
                                  .blocklyText.blocklyDropdownText { fill: #000; }
                                  .blocklyEditableText > rect {
                                      fill: #fff;
                                      fill-opacity: 0.6;
                                      stroke: none;
                                  }
                                  .blocklyPathLight {    
                                    fill: none;
                                    stroke-linecap: round;
                                    stroke-width: 1;
                                  }`;
        svg.appendChild(styleElement);

        var serializer = new XMLSerializer();
        var source = serializer.serializeToString(svg);

        //add name spaces.
        if (
          !source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)
        ) {
          source = source.replace(
            /^<svg/,
            '<svg xmlns="http://www.w3.org/2000/svg"'
          );
        }
        if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
          source = source.replace(
            /^<svg/,
            '<svg xmlns:xlink="http://www.w3.org/1999/xlink"'
          );
        }

        // Add xml declaration
        source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

        // Convert SVG source to URI data scheme.
        var url =
          "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

        // Set up download link
        var link = document.createElement("a");
        link.href = url;
        link.download = "blockly_workspace.svg";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function updateCode() {
        var imports = generateImports();
        var code = Blockly.Python.workspaceToCode(workspace);
        document.getElementById("codeArea").textContent = imports + "\n" + code;
      }

      workspace.addChangeListener(updateCode);
      
      window.onload = function () {
        loadWorkspace();
        updateCode();
      };
    </script>
  </body>
</html>
