import{aQ as Z,aR as F,c as E,aS as W,aT as $,aU as D,j as g,E as G,$ as C,Y as j,aV as K,aW as I,aX as R,L as _,aY as V,aZ as Y,a_ as q,a$ as Q,b0 as U,ab as X,b1 as B}from"./index-DlQKt39j.js";import{M as y}from"./compile-DnHFbvjV.js";import{a as J}from"./VegaLite-GVqhQbDs.js";import"./index-B_2-onrX.js";const L=new Set(["boxplot","errorband","errorbar"]),S={getMarkType(e){const t=typeof e=="string"?e:e.type;if(L.has(t))throw new Error("Not supported");return t},isInteractive(e){const t=typeof e=="string"?e:e.type;return!L.has(t)},makeClickable(e){const t=typeof e=="string"?e:e.type;return t in y?typeof e=="string"?{type:e,cursor:"pointer",tooltip:!0}:{...e,type:t,cursor:"pointer",tooltip:!0}:e},getOpacity:e=>typeof e=="string"?null:"opacity"in e&&typeof e.opacity=="number"?e.opacity:null},ee=new Set(["color","fill","fillOpacity","opacity","shape","size"]);function te(e,t,r,i){const u={and:r.map(d=>({param:d}))};if(e==="opacity"){const d=S.getOpacity(i)||1;return{...t,opacity:{condition:{test:u,value:d},value:d/5}}}return t}const w={point:e=>e==null?"select_point":`select_point_${e}`,interval:e=>e==null?"select_interval":`select_interval_${e}`,legendSelection:e=>`legend_selection_${e}`,HIGHLIGHT:"highlight",PAN_ZOOM:"pan_zoom",hasPoint:e=>e.some(t=>t.startsWith("select_point")),hasInterval:e=>e.some(t=>t.startsWith("select_interval")),hasLegend:e=>e.some(t=>t.startsWith("legend_selection")),hasPanZoom:e=>e.some(t=>t.startsWith("pan_zoom"))},P={highlight:()=>({name:w.HIGHLIGHT,select:{type:"point",on:"mouseover"}}),interval:(e,t)=>({name:w.interval(t),select:{type:"interval",encodings:T(e),mark:{fill:"#669EFF",fillOpacity:.07,stroke:"#669EFF",strokeOpacity:.4},on:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]",translate:"[mousedown[!event.metaKey], mouseup] > mousemove[!event.metaKey]"}}),point:(e,t)=>({name:w.point(t),select:{type:"point",encodings:T(e),on:"click[!event.metaKey]"}}),legend:e=>({name:w.legendSelection(e),select:{type:"point",fields:[e]},bind:"legend"}),panZoom:()=>({name:w.PAN_ZOOM,bind:"scales",select:{type:"interval",on:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",translate:"[mousedown[event.metaKey], window:mouseup] > window:mousemove!",zoom:"wheel![event.metaKey]"}})};function T(e){switch(S.getMarkType(e.mark)){case y.image:case y.trail:return;case y.area:case y.arc:return["color"];case y.bar:{const t=function(r){var d,l;if(!r||!("mark"in r))return;const i=(d=r.encoding)==null?void 0:d.x,u=(l=r.encoding)==null?void 0:l.y;if(i&&"type"in i&&i.type==="nominal")return"vertical";if(u&&"type"in u&&u.type==="nominal"||i&&"aggregate"in i)return"horizontal";if(u&&"aggregate"in u)return"vertical"}(e);return t==="horizontal"?["y"]:t==="vertical"?["x"]:void 0}case y.circle:case y.geoshape:case y.line:case y.point:case y.rect:case y.rule:case y.square:case y.text:case y.tick:return["x","y"]}}function z(e){return"params"in e&&e.params&&e.params.length>0?e.params.filter(t=>t!=null&&"select"in t&&t.select!==void 0).map(t=>t.name):"layer"in e?[...new Set(e.layer.flatMap(z))]:[]}function ae(e,t){var f,v;let{chartSelection:r=!0,fieldSelection:i=!0}=t;if(!r&&!i)return e;if(((f=e.params)==null?void 0:f.some(c=>c.bind==="legend"))&&(i=!1),((v=e.params)==null?void 0:v.some(c=>!c.bind))&&(r=!1),"vconcat"in e){const c=e.vconcat.map(o=>"mark"in o?O(o):o);return{...e,vconcat:c}}if("hconcat"in e){const c=e.hconcat.map(o=>"mark"in o?O(o):o);return{...e,hconcat:c}}if("layer"in e){const c=e.layer.map((o,p)=>{if(!("mark"in o))return o;let s=o;return s=A(s,r,p),s=O(s),p===0&&(s=H(s)),s});return{...e,layer:c}}if(!("mark"in e)||!S.isInteractive(e.mark))return e;let l=e;return l=function(c,o){if(o===!1)return c;let p=function(h){if(!h||!("encoding"in h))return[];const{encoding:b}=h;return b?Object.entries(b).flatMap(a=>{const[n,m]=a;return m&&ee.has(n)?"field"in m&&typeof m.field=="string"?[m.field]:"condition"in m&&m.condition&&typeof m.condition=="object"&&"field"in m.condition&&m.condition.field&&typeof m.condition.field=="string"?[m.condition.field]:[]:[]}):[]}(c);Array.isArray(o)&&(p=p.filter(h=>o.includes(h)));const s=p.map(h=>P.legend(h)),x=[...c.params||[],...s];return{...c,params:x}}(l,i),l=A(l,r,void 0),l=O(l),l=H(l),l}function A(e,t,r){if(t===!1)return e;let i;try{i=S.getMarkType(e.mark)}catch{return e}if(i==="geoshape")return e;const u=t===!0?function(f){switch(f){case"arc":case"area":return["point"];case"text":case"bar":default:return["point","interval"];case"line":return}}(i):[t];if(!u)return e;const d=u.map(f=>f==="interval"?P.interval(e,r):P.point(e,r)),l=[...e.params||[],...d];return{...e,params:l}}function H(e){let t;try{t=S.getMarkType(e.mark)}catch{}if(t==="geoshape")return e;const r=e.params||[];return r.some(i=>i.bind==="scales")?e:{...e,params:[...r,P.panZoom()]}}function O(e){const t="encoding"in e?e.encoding:void 0,r=e.params||[],i=r.map(u=>u.name);return r.length===0?e:S.isInteractive(e.mark)?{...e,mark:S.makeClickable(e.mark),encoding:te("opacity",t||{},i,e.mark)}:e}$("arrow",D);const ne=e=>{const t=E.c(11),{value:r,setValue:i,chartSelection:u,fieldSelection:d,spec:l}=e;let f,v;t[0]!==l?(f=async()=>async function(s){if(!s)return s;const x="datasets"in s?{...s.datasets}:{},h=async a=>{if(!a)return a;if("layer"in a){const k=await Promise.all(a.layer.map(h));a={...a,layer:k}}if("hconcat"in a){const k=await Promise.all(a.hconcat.map(h));a={...a,hconcat:k}}if("vconcat"in a){const k=await Promise.all(a.vconcat.map(h));a={...a,vconcat:k}}if("spec"in a&&(a={...a,spec:await h(a.spec)}),!a.data||!("url"in a.data))return a;let n;try{n=Z(a.data.url)}catch{return a}const m=await F(n.href,a.data.format);return x[n.pathname]=m,{...a,data:{name:n.pathname}}},b=await h(s);return Object.keys(x).length===0?b:{...b,datasets:x}}(l),v=[l],t[0]=l,t[1]=f,t[2]=v):(f=t[1],v=t[2]);const{data:c,error:o}=W(f,v);if(o){let s;return t[3]!==o?(s=g.jsx(G,{error:o}),t[3]=o,t[4]=s):s=t[4],s}if(!c)return null;let p;return t[5]!==u||t[6]!==d||t[7]!==c||t[8]!==i||t[9]!==r?(p=g.jsx(re,{value:r,setValue:i,chartSelection:u,fieldSelection:d,spec:c}),t[5]=u,t[6]=d,t[7]=c,t[8]=i,t[9]=r,t[10]=p):p=t[10],p},re=({value:e,setValue:t,chartSelection:r,fieldSelection:i,spec:u})=>{const{theme:d}=C(),l=j.useRef(void 0),[f,v]=j.useState(),c=K(u),o=j.useMemo(()=>ae(function(n){return n.data&&"url"in n.data&&(n.data.url=Z(n.data.url).href),n}(c),{chartSelection:r,fieldSelection:i}),[c,r,i]),p=j.useMemo(()=>z(o),[o]),s=I(n=>{t({...e,...n})}),x=K(p),h=j.useMemo(()=>x.reduce((n,m)=>(w.PAN_ZOOM===m||(n[m]=R((k,N)=>{_.debug("[Vega signal]",k,N);let M=V.mapValues(N,se);M=V.mapValues(M,oe),s({[k]:M})},100)),n),{}),[x,s]),b=I(n=>{_.error(n),_.debug(o),v(n)}),a=I(n=>{_.debug("[Vega view] created",n),l.current=n,v(void 0)});return g.jsxs(g.Fragment,{children:[f&&g.jsxs(Y,{variant:"destructive",children:[g.jsx(q,{children:f.message}),g.jsx("div",{className:"text-md",children:f.stack})]}),g.jsxs("div",{className:"relative",onPointerDown:Q.stopPropagation(),children:[g.jsx(J,{spec:o,theme:d==="dark"?"dark":void 0,actions:ie,signalListeners:h,onError:b,onNewView:a}),(()=>{const n=[];return w.hasPoint(p)&&n.push(["Point selection","click to select a point; hold shift for multi-select"]),w.hasInterval(p)&&n.push(["Interval selection","click and drag to select an interval"]),w.hasLegend(p)&&n.push(["Legend selection","click to select a legend item; hold shift for multi-select"]),w.hasPanZoom(p)&&n.push(["Pan","hold the meta key and drag"],["Zoom","hold the meta key and scroll"]),n.length===0?null:g.jsx(X,{delayDuration:300,side:"left",content:g.jsx("div",{className:"text-xs flex flex-col",children:n.map((m,k)=>g.jsxs("div",{children:[g.jsxs("span",{className:"font-bold tracking-wide",children:[m[0],":"]})," ",m[1]]},k))}),children:g.jsx(B,{className:"absolute bottom-1 right-0 m-2 h-4 w-4 cursor-help text-muted-foreground hover:text-foreground"})})})()]})]})},ie={source:!1,compiled:!1};function oe(e){return e instanceof Set?[...e]:e}function se(e){return Array.isArray(e)?e.map(t=>t instanceof Date&&U(t)?new Date(t).getTime():t):e}export{ne as default};
