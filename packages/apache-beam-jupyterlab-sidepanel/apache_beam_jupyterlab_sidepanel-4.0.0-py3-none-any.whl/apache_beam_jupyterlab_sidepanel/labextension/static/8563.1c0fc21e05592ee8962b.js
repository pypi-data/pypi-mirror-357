"use strict";(self.webpackChunkapache_beam_jupyterlab_sidepanel=self.webpackChunkapache_beam_jupyterlab_sidepanel||[]).push([[8563],{2737:(e,t,n)=>{n.r(t),n.d(t,{default:()=>j});var s,i=n(9560),a=n(8607),l=n(5577),r=n(1767),o=n(5256),d=n(3345),c=n(8467),p=n(7027),u=n(7159),h=n(4109),m=n(7403),_=n(133),b=n(4602);!function(e){e.COMMON_KERNEL_IMPORTS="from apache_beam.runners.interactive import interactive_beam as ib\nfrom apache_beam.runners.interactive import interactive_environment as ie\n"}(s||(s={}));class v{constructor(e,t=!1){this._future=null,this._displayData=new Array,this._displayUpdate=new Array,this._executeResult=null,this._stateChanged=new b.Signal(this),this._enableConsoleLog=!1,this._isDone=!0,this._sessionContext=e,this._enableConsoleLog=t}get future(){return this._future}set future(e){this._future!==e&&(this._future&&this._future.dispose(),this._future=e,e&&(e.onIOPub=this._onIOPub.bind(this)))}get executeResult(){if(this._executeResult){const e=this._executeResult.data["text/plain"];if(e)try{const t=e.slice(1,-1).replace(/\\'/g,"'");return JSON.parse(t)}catch(e){return console.error(e),{}}}return{}}get displayData(){return this._displayData}get displayUpdate(){return this._displayUpdate}get stateChanged(){return this._stateChanged}get isDone(){return this._isDone}execute(e,t=!0){var n,i,a;this.future&&(this.future.dispose(),this.future=null),this._executeResult=null,this._displayData.length=0,this._displayUpdate.length=0,this._sessionContext&&(null===(n=this._sessionContext.session)||void 0===n?void 0:n.kernel)&&(this._isDone=!1,this.future=null===(a=null===(i=this._sessionContext.session)||void 0===i?void 0:i.kernel)||void 0===a?void 0:a.requestExecute({code:s.COMMON_KERNEL_IMPORTS+e,silent:!t,store_history:!1}))}interruptKernel(){var e,t;null===(t=null===(e=this._sessionContext.session)||void 0===e?void 0:e.kernel)||void 0===t||t.interrupt(),this._isDone=!0}_onIOPub(e){switch(this._enableConsoleLog&&console.log(e),e.header.msg_type){case"execute_result":{const t=e.content;this._executeResult=t,this._stateChanged.emit(),this._isDone=!0;break}case"display_data":{const t=e.content;this._displayData.push(t),this._stateChanged.emit(),this._isDone=!1;break}case"update_display_data":{const t=e.content;this._displayUpdate.push(t),this._stateChanged.emit(),this._isDone=!1;break}case"status":this._isDone=!0}}}n(4891),n(8584),n(4379),n(9486),n(4495),n(9094);class y extends d.Component{constructor(e){super(e),this._inspectKernelCode="ie.current_env().inspector.list_clusters()",this._model=new v(this.props.sessionContext),this.state={kernelDisplayName:"no kernel",clusters:this._model.executeResult,defaultClusterId:"",selectedId:"",selectedName:"",showDialog:!1,displayTable:!0}}componentDidMount(){this._queryKernelTimerId=setInterval(()=>this.queryKernel(this._inspectKernelCode),2e3),this._updateRenderTimerId=setInterval(()=>this.updateRender(),1e3),this._updateSessionInfoTimerId=setInterval(()=>this.updateSessionInfo(),2e3)}componentWillUnmount(){clearInterval(this._queryKernelTimerId),clearInterval(this._updateRenderTimerId),clearInterval(this._updateSessionInfoTimerId)}queryKernel(e){this._model.execute(e)}updateRender(){const e=this._model.executeResult;Object.keys(e).length&&(this.setState({displayTable:!0}),JSON.stringify(this.state.clusters)!==JSON.stringify(e)&&this.setState({clusters:e}))}updateSessionInfo(){if(this.props.sessionContext){const e=this.props.sessionContext.kernelDisplayName;e!==this.state.kernelDisplayName&&this.setState({kernelDisplayName:e})}}setDefaultCluster(e){const t=`ie.current_env().clusters.set_default_cluster(ie.current_env().inspector.get_cluster_master_url('${e}'))`;this.queryKernel(t),this.setState({defaultClusterId:e})}displayDialog(e,t,n){this.setState({showDialog:e,selectedId:t,selectedName:n})}deleteCluster(e){const t=`ie.current_env().clusters.cleanup(ie.current_env().inspector.get_cluster_master_url('${e}'))`;if(this.queryKernel(t),this.state.defaultClusterId===e){const e="ie.current_env().clusters.default_cluster_metadata=None";this.queryKernel(e),this.setState({defaultClusterId:""})}1===Object.keys(this.state.clusters).length&&this.setState({displayTable:!1})}render(){if(Object.keys(this.state.clusters).length&&this.state.displayTable){const e=[],t=Object.entries(this.state.clusters).map(([t,n])=>{const s=n.pipelines.join(", ");return e.push({label:`Cluster: ${n.cluster_name}, Project: ${n.project}, Region: ${n.region}`,value:t}),d.createElement(p.DataTableRow,{key:t},d.createElement(p.DataTableHeadCell,null,n.cluster_name),d.createElement(p.DataTableHeadCell,null,n.project),d.createElement(p.DataTableHeadCell,null,n.region),d.createElement(p.DataTableHeadCell,null,n.master_url),d.createElement(p.DataTableHeadCell,null,s),d.createElement(p.DataTableHeadCell,null,d.createElement(c.Button,{onClick:e=>{e.preventDefault(),window.location.href=n.dashboard}},"Dashboard")),d.createElement(p.DataTableHeadCell,null,d.createElement(h.Fab,{icon:"delete",style:{backgroundColor:"var(--mdc-theme-error)"},theme:["onError"],mini:!0,onClick:()=>{this.displayDialog(!0,t,n.cluster_name)}})))});return d.createElement(d.Fragment,null,d.createElement(_.TopAppBar,{fixed:!0,dense:!0},d.createElement(_.TopAppBarRow,null,d.createElement(_.TopAppBarSection,null,d.createElement(_.TopAppBarTitle,null,"Clusters [kernel:",this.state.kernelDisplayName,"]")))),d.createElement(_.TopAppBarFixedAdjust,null),d.createElement(m.l,{label:"Default cluster",enhanced:!0,options:e,onChange:e=>this.setDefaultCluster(e.currentTarget.value),value:this.state.defaultClusterId}),d.createElement(u.Dialog,{open:this.state.showDialog,onClose:e=>{this.displayDialog(!1,"","")}},d.createElement(u.DialogTitle,null,"Confirm Cluster Deletion"),d.createElement(u.DialogContent,null,"Are you sure you want to delete ",this.state.selectedName,"?"),d.createElement(u.DialogActions,null,d.createElement(u.DialogButton,{isDefaultAction:!0,action:"close"},"Cancel"),d.createElement(u.DialogButton,{action:"accept",onClick:()=>{this.deleteCluster(this.state.selectedId)}},"Delete"))),d.createElement("div",{className:"Clusters"},d.createElement(p.DataTable,null,d.createElement(p.DataTableContent,null,d.createElement(p.DataTableHead,null,d.createElement(p.DataTableRow,null,d.createElement(p.DataTableHeadCell,null,"Cluster"),d.createElement(p.DataTableHeadCell,null,"Project"),d.createElement(p.DataTableHeadCell,null,"Region"),d.createElement(p.DataTableHeadCell,null,"Master URL"),d.createElement(p.DataTableHeadCell,null,"Pipelines"),d.createElement(p.DataTableHeadCell,null,"Dashboard Link"))),d.createElement(p.DataTableBody,null,t)))))}return d.createElement("div",null,"No clusters detected.")}}class f extends i.ReactWidget{constructor(e){super(),this._sessionContext=e}render(){return d.createElement(y,{sessionContext:this._sessionContext})}}class C extends o.BoxPanel{constructor(e,t,n,s,i){super({direction:"top-to-bottom",alignment:"end"}),this.id="apache-beam-jupyterlab-sidepanel",this.title.label=s,this.title.closable=!0,this._sessionContext=n,this._widget=i,this.addWidget(this._widget),this.initializeSession(e)}async initializeSession(e){if(!await this._sessionContext.initialize())return void console.error("Cannot initialize the session in SidePanel.");const t=e.sessions.running(),n=t.next();let s=!0;if(void 0===n)s=!1;else{let e=t.next();for(;void 0!==e;){if(e.value.kernel.id!==n.value.kernel.id){s=!1;break}e=t.next()}}try{if(s)this._sessionContext.sessionManager.connectTo({model:n.value,kernelConnectionOptions:{handleComms:!1}}),this._sessionContext.changeKernel(n.value.kernel);else{const e=new i.SessionContextDialogs;await e.selectKernel(this._sessionContext)}}catch(e){console.error(`Failed to initialize the session in SidePanel.\n${e}`)}}get session(){return this._sessionContext}dispose(){this._sessionContext.dispose(),super.dispose()}onCloseRequest(e){super.onCloseRequest(e),this.dispose()}}class g{constructor(e){this._options={},this._model=new v(e)}buildShowGraphQuery(){return`ib.show_graph(ie.current_env().inspector.get_val('${this._identifier}'))`}buildShowQuery(e={}){let t="";e.includeWindowInfo?t+="include_window_info=True":t+="include_window_info=False",t+=", ",e.visualizeInFacets?t+="visualize_data=True":t+="visualize_data=False",t+=", ",e.duration||(e.duration="inf");const n=Number(e.duration);isNaN(n)?t+=`duration='${e.duration}'`:n<=0?(e.duration="inf",t+="duration='inf'"):(e.duration=Math.floor(n).toString(10),t+="duration="+Math.floor(n)),t+=", ";const s=Number(e.n),i=Math.floor(s);return isNaN(s)||i<=0?(e.n="inf",t+="n='inf'"):(e.n=i.toString(10),t+="n="+i),`ib.show(ie.current_env().inspector.get_val('${this._identifier}'),`+t+")"}get kernelModel(){return this._model}interruptKernelIfNotDone(){this._model.isDone||this._model.interruptKernel()}queryKernel(e,t,n={}){this.interruptKernelIfNotDone(),this._inspectableType=e.toLowerCase(),this._identifier=t,this._options=n,"pipeline"===this._inspectableType?this._model.execute(this.buildShowGraphQuery()):this._model.execute(this.buildShowQuery(n))}get inspectableType(){return this._inspectableType}get identifier(){return this._identifier}get options(){return this._options}set options(e){this._options=e,this.queryKernel(this.inspectableType,this.identifier,this.options)}get displayData(){return this._model.displayData}get displayUpdate(){return this._model.displayUpdate}get html(){return this.displayData.map(e=>this.extractHtmlFromDisplayData(e)).reduce((e,t)=>e+t,"")}get script(){return this.displayData.map(e=>this.extractScriptFromDisplayData(e))}extractHtmlFromDisplayData(e){let t="";if("data"in e){const n=e.data;"text/html"in n&&(t+=n["text/html"]+"\n")}return t}extractScriptFromDisplayData(e){let t="";if("data"in e){const n=e.data;if("application/javascript"in n&&(t+=n["application/javascript"]+"\n"),"text/html"in n){const e=document.createElement("div");e.innerHTML=n["text/html"];const s=e.getElementsByTagName("script");for(const e of s)t+=e.text+"\n"}}return t}}var I=n(603),D=n(1171);n(6691);class w extends d.Component{constructor(e){super(e),this.show=this.show.bind(this),this.state={activated:!1}}componentDidMount(){this._updateRenderTimerId=setInterval(()=>this.updateRender(),500)}componentWillUnmount(){clearInterval(this._updateRenderTimerId)}updateRender(){var e,t;this.setState({activated:(null===(t=null===(e=this.props)||void 0===e?void 0:e.inspectableViewModel)||void 0===t?void 0:t.identifier)===this.props.id})}show(){this.props.inspectableViewModel.queryKernel(this.props.metadata.type,this.props.id,this.props.inspectableViewModel.options)}render(){var e,t;return d.createElement(D.ListItem,{style:{height:"55px",paddingLeft:"5px"},onClick:this.show,activated:(null===(t=null===(e=this.props)||void 0===e?void 0:e.inspectableViewModel)||void 0===t?void 0:t.identifier)===this.props.id},d.createElement(D.ListItemText,null,d.createElement(D.ListItemPrimaryText,null,this.props.metadata.name),d.createElement(D.ListItemSecondaryText,null,"pcollection")))}}class T extends d.Component{constructor(e){super(e),this._onClickHeader=this._onClickHeader.bind(this),this.state={activated:!1}}componentDidMount(){this._updateRenderTimerId=setInterval(()=>this.updateRender(),500)}componentWillUnmount(){clearInterval(this._updateRenderTimerId)}render(){return d.createElement(d.Fragment,null,d.createElement(D.CollapsibleList,{defaultOpen:!0,handle:d.createElement(D.SimpleListItem,{style:{height:"55px",paddingLeft:"0px"},text:this.props.metadata.name,secondaryText:"pipeline",metaIcon:"chevron_right",activated:this.state.activated}),onOpen:this._onClickHeader,onClose:this._onClickHeader},this._buildListItems()),d.createElement(D.ListDivider,null))}updateRender(){var e,t;this.setState({activated:(null===(t=null===(e=this.props)||void 0===e?void 0:e.inspectableViewModel)||void 0===t?void 0:t.identifier)===this.props.id})}_onClickHeader(){var e,t;(null===(t=null===(e=this.props)||void 0===e?void 0:e.inspectableViewModel)||void 0===t?void 0:t.identifier)!==this.props.id&&this.props.inspectableViewModel.queryKernel(this.props.metadata.type,this.props.id)}_buildListItems(){return Object.entries(this.props.pcolls).map(([e,t])=>{const n={inspectableViewModel:this.props.inspectableViewModel,id:e,metadata:t};return d.createElement(w,Object.assign({key:e},n))})}}class x extends d.Component{constructor(e){super(e),this._inspectKernelCode="from apache_beam.runners.interactive import interactive_environment as ie\nie.current_env().inspector.list_inspectables()",this._model=new v(this.props.sessionContext),this.state={inspectables:this._model.executeResult}}componentDidMount(){this._queryKernelTimerId=setInterval(()=>this.queryKernel(),2e3),this._updateRenderTimerId=setInterval(()=>this.updateRender(),1e3)}componentWillUnmount(){clearInterval(this._queryKernelTimerId),clearInterval(this._updateRenderTimerId)}queryKernel(){this._model.execute(this._inspectKernelCode)}updateRender(){const e=this._model.executeResult;Object.keys(e).length&&JSON.stringify(this.state.inspectables)!==JSON.stringify(e)&&this.setState({inspectables:e})}render(){if(Object.keys(this.state.inspectables).length){const e=Object.entries(this.state.inspectables).map(([e,t])=>{const n=Object.assign({inspectableViewModel:this.props.inspectableViewModel,id:e},t);return d.createElement(T,Object.assign({key:e},n))});return d.createElement(D.List,{className:"Inspectables"},e)}return d.createElement("div",null,"No inspectable pipeline nor pcollection has been defined.")}}var E,S=n(5340),k=n(9265),R=n(1617);class M extends d.Component{constructor(e){super(e),this.state={innerHtml:e.htmlProvider.html,script:[]}}componentDidMount(){this._updateRenderTimerId=setInterval(()=>this.updateRender(),1e3)}componentWillUnmount(){clearInterval(this._updateRenderTimerId)}updateRender(){const e=this.state.innerHtml,t=this.props.htmlProvider.html,n=this.state.script,s=[...this.props.htmlProvider.script];t!==e&&this.setState({innerHtml:t,script:[]});const i=t===e?n.length:0;s.length>i&&this.setState({script:s},()=>{for(let e=i;e<s.length;++e)new Function(s[e])()})}render(){return d.createElement("div",{dangerouslySetInnerHTML:{__html:this.state.innerHtml}})}}class O extends d.Component{constructor(e){super(e),this.state={hidden:!0},this.onClick=this.onClick.bind(this)}componentDidMount(){this._updateRenderTimerId=setInterval(()=>this.updateRender(),1e3)}componentWillUnmount(){clearInterval(this._updateRenderTimerId)}onClick(){this.props.model.interruptKernel(),this.setState({hidden:!0})}updateRender(){this.props.model.isDone?this.setState({hidden:!0}):this.setState({hidden:!1})}render(){return this.state.hidden?null:d.createElement(c.Button,{label:"stop",onClick:this.onClick,danger:!0,raised:!0})}}n(6436),n(5818),n(5692);class N extends d.Component{constructor(e){super(e),this.state={inspectableType:e.model.inspectableType,identifier:e.model.identifier,options:e.model.options},this.applyShowOptions=this.applyShowOptions.bind(this)}componentDidMount(){this._updateRenderTimerId=setInterval(()=>this.updateRender(),1e3)}componentWillUnmount(){clearInterval(this._updateRenderTimerId)}updateRender(){this.props.model.identifier!==this.state.identifier&&("pcollection"===this.props.model.inspectableType?this.setState({inspectableType:"pcollection",identifier:this.props.model.identifier,options:this._buildShowOptions(this.props.model.options)}):this.setState({inspectableType:"pipeline",identifier:this.props.model.identifier,options:{}}))}renderOptions(){if("pcollection"!==this.props.model.inspectableType)return d.createElement("span",null);const e=this._buildShowOptions(this.state.options),t=this._renderIncludeWindowInfo(e),n=this._renderVisualizeInFacets(e),s=this._renderDuration(e),i=this._renderN(e);return d.createElement("div",{style:{padding:"5px"}},t,n,s,i,d.createElement(c.Button,{label:"apply",onClick:()=>this.applyShowOptions(e),raised:!0}))}applyShowOptions(e){this.setState({options:e}),this.props.model.options=e}_renderIncludeWindowInfo(e){return d.createElement(R.Tooltip,{content:"Whether to include window info."},d.createElement(S.S,{label:"Include Window Info",checked:e.includeWindowInfo,onChange:t=>{e.includeWindowInfo=!!t.currentTarget.checked,this.setState({options:e})}}))}_renderVisualizeInFacets(e){return d.createElement(R.Tooltip,{content:"Whether to visualize the data in Facets."},d.createElement(S.S,{label:"Visualize in Facets",checked:e.visualizeInFacets,onChange:t=>{e.visualizeInFacets=!!t.currentTarget.checked,this.setState({options:e})}}))}_renderDuration(e){return d.createElement(R.Tooltip,{content:"Max duration of elements to read in integer seconds or a string duration that is parsable by pandas.to_timedelta, such as 1m or 60s. Otherwise, default value `inf` is used: the visualization will never end until manually stopped by interrupting the kernel or reaches a hard cap set by ib.options.capture_size_limit."},d.createElement(k.TextField,{outlined:!0,label:"Duration",floatLabel:!0,placeholder:e.duration,onChange:t=>{e.duration=t.currentTarget.value}}))}_renderN(e){return d.createElement(R.Tooltip,{content:"Max number of elements to visualize. Please fill in a positive integer. Otherwise, default value `inf` is used: the visualization will never end until manually stopped by interrupting the kernel or reaches a hard cap set by ib.options.capture_duration."},d.createElement(k.TextField,{outlined:!0,label:"Element Number",floatLabel:!0,placeholder:e.n,onChange:t=>{e.n=t.currentTarget.value}}))}render(){const e=this.renderOptions(),t=this.props.model;return d.createElement("div",{className:"InspectableView"},d.createElement("div",null,e),d.createElement(O,{model:this.props.model.kernelModel}),d.createElement(M,{htmlProvider:t}))}_buildShowOptions(e){const t=e;return{includeWindowInfo:!!(null==t?void 0:t.includeWindowInfo),visualizeInFacets:!!(null==t?void 0:t.visualizeInFacets),duration:null==t?void 0:t.duration,n:null==t?void 0:t.n}}}n(7844);class K extends d.Component{constructor(e){super(e),this.state={drawerOpen:!0,kernelDisplayName:"no kernel"},this.flipDrawer=this.flipDrawer.bind(this)}componentDidMount(){this._updateSessionInfoTimerId=setInterval(()=>this.updateSessionInfo(),2e3)}componentWillUnmount(){clearInterval(this._updateSessionInfoTimerId)}updateSessionInfo(){if(this.props.sessionContext){const e=this.props.sessionContext.kernelDisplayName;e!==this.state.kernelDisplayName&&this.setState({kernelDisplayName:e})}}flipDrawer(){this.setState({drawerOpen:!this.state.drawerOpen})}render(){return d.createElement(d.Fragment,null,d.createElement(_.TopAppBar,{fixed:!0,dense:!0},d.createElement(_.TopAppBarRow,null,d.createElement(_.TopAppBarSection,null,d.createElement(_.TopAppBarNavigationIcon,{icon:"menu",onClick:this.flipDrawer}),d.createElement(_.TopAppBarTitle,null,"Inspector [kernel:",this.state.kernelDisplayName,"]")))),d.createElement(_.TopAppBarFixedAdjust,null),d.createElement("div",{className:"InteractiveInspector"},d.createElement(I.Drawer,{dismissible:!0,open:this.state.drawerOpen},d.createElement(I.DrawerContent,null,d.createElement(x,{sessionContext:this.props.sessionContext,inspectableViewModel:this.props.inspectableViewModel}))),d.createElement(I.DrawerAppContent,null,d.createElement(N,{model:this.props.inspectableViewModel}))))}}class H extends i.ReactWidget{constructor(e){super(),this._sessionContext=e,this._inspectableViewModel=new g(e)}render(){return d.createElement(K,{sessionContext:this._sessionContext,inspectableViewModel:this._inspectableViewModel})}}!function(e){e.open_inspector="apache-beam-jupyterlab-sidepanel:open_inspector",e.open_clusters_panel="apache-beam-jupyterlab-sidepanel:open_clusters_panel"}(E||(E={}));const j={id:"apache-beam-jupyterlab-sidepanel",autoStart:!0,optional:[a.ILauncher],requires:[i.ICommandPalette,l.IMainMenu,r.IRenderMimeRegistry],activate:function(e,t,n,s,a){const l="Interactive Beam",{commands:r,shell:d,serviceManager:c}=e;function p(e){d.add(e,"main"),d.activateById(e.id)}r.addCommand(E.open_inspector,{label:"Open Inspector",execute:async function(){const e=new i.SessionContext({sessionManager:c.sessions,specsManager:c.kernelspecs,name:"Interactive Beam Inspector Session"}),t=new H(e),n=new C(c,s,e,"Interactive Beam Inspector",t);return p(n),n}}),r.addCommand(E.open_clusters_panel,{label:"Manage Clusters",execute:async function(){const e=new i.SessionContext({sessionManager:c.sessions,specsManager:c.kernelspecs,name:"Interactive Beam Clusters Session"}),t=new f(e),n=new C(c,s,e,"Interactive Beam Cluster Manager",t);return p(n),n}}),a&&(a.add({command:E.open_inspector,category:l}),a.add({command:E.open_clusters_panel,category:l}));const u=new o.Menu({commands:r});u.title.label="Interactive Beam",n.addMenu(u),u.addItem({command:E.open_inspector}),u.addItem({command:E.open_clusters_panel}),t.addItem({command:E.open_inspector,category:l}),t.addItem({command:E.open_clusters_panel,category:l})}}}}]);